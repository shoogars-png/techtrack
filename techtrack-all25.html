<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TechTrack</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* PAGE SYSTEM */
.page { display: none !important; }
.page.active { display: block !important; }

/* DASHBOARD LAYOUT */
.dash-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(0,0,0,0.06);
  box-shadow: 0 2px 20px rgba(0,0,0,0.10);
  padding: 0 2rem;
  display: flex; align-items: center; justify-content: space-between;
  height: 64px;
}
.dash-main { padding: 2rem; max-width: 1400px; margin: 0 auto; }

/* DASHBOARD LAYOUT */
.dash-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(0,0,0,0.06);
  box-shadow: 0 2px 20px rgba(0,0,0,0.10);
  padding: 0 2rem;
  display: flex; align-items: center; justify-content: space-between;
  height: 64px;
}
.dash-main {
  padding: 2rem; max-width: 1400px; margin: 0 auto;
}

/* TRACKER */

  :root {
    --bg: transparent;
    --surface: #ffffff;
    --surface2: #f2f6f8;
    --mission-card: #edf4f7;
    --mission-card-border: rgba(0,0,0,0.08);
    --border: rgba(0,0,0,0.10);
    --text: #1e2d3d;
    --muted: #6e859a;
    --accent: #2bbdc8;

    --waiting:  #e8943a;
    --progress: #2bbdc8;
    --done:     #27b589;
    --blocked:  #e05252;

    --t1: #e05252;
    --t2: #2bbdc8;
    --t3: #e8943a;
    --t4: #8e6fd4;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: linear-gradient(145deg, #5b9ecf 0%, #7ec8c8 55%, #5bafc0 100%);
    background-attachment: fixed;
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0; z-index: 0;
    background:
      radial-gradient(ellipse 60% 50% at 15% 20%, rgba(255,255,255,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 40% 40% at 85% 80%, rgba(0,0,0,0.10) 0%, transparent 60%);
    pointer-events: none;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(0,0,0,0.08);
    box-shadow: 0 2px 20px rgba(0,0,0,0.15);
    padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
  }

  .logo {
    font-family: 'Syne', sans-serif;
    font-size: 1.4rem; font-weight: 800;
    letter-spacing: -0.03em;
    color: #2c3e50;
  }
  .logo span { color: #3bbfb0; }

  .header-right { display: flex; gap: .75rem; align-items: center; }

  .clock {
    font-family: 'Syne', sans-serif;
    font-size: .95rem; font-weight: 600;
    color: var(--accent);
    background: rgba(58,176,195,0.1);
    padding: .35rem .85rem;
    border-radius: 999px;
    border: 1px solid rgba(58,176,195,0.3);
    letter-spacing: .04em;
  }

  .btn {
    font-family: 'DM Sans', sans-serif;
    font-size: .82rem; font-weight: 500;
    padding: .45rem 1rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.25);
    cursor: pointer;
    transition: all .2s;
    display: flex; align-items: center; gap: .4rem;
  }
  .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-primary:hover { filter: brightness(1.1); }
  .btn-ghost { background: rgba(255,255,255,0.15); color: #fff; border-color: rgba(255,255,255,0.2); }
  .btn-ghost:hover { background: rgba(255,255,255,0.28); }
  .btn-danger { background: rgba(224,92,92,0.2); color: #e05c5c; border-color: rgba(224,92,92,0.35); }
  .btn-danger:hover { background: rgba(224,92,92,0.35); }
  .btn-success { background: rgba(76,175,130,0.2); color: var(--done); border-color: rgba(76,175,130,0.35); }
  .btn-success:hover { background: rgba(76,175,130,0.35); }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  main { position: relative; z-index: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; }

  /* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
  .stats-bar {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
    margin-bottom: 2.5rem;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    padding: 1.6rem 2rem;
    display: flex; align-items: center; gap: 1.4rem;
    animation: fadeUp .5s ease both;
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
    transition: transform .2s, box-shadow .2s;
  }
  .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 32px rgba(0,0,0,0.18); }
  .stat-card:nth-child(2) { animation-delay: .05s; }
  .stat-card:nth-child(3) { animation-delay: .1s; }
  .stat-card:nth-child(4) { animation-delay: .15s; }

  .stat-icon {
    width: 62px; height: 62px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .stat-label { font-size: .75rem; color: #5a7080; margin-bottom: .3rem; font-weight: 700; letter-spacing: .05em; text-transform: uppercase; }
  .stat-value { font-family: 'Syne', sans-serif; font-size: 3.2rem; font-weight: 800; line-height: 1; }
  .stat-sub { font-size: .72rem; color: #8aa0b0; margin-top: .35rem; }

  /* ‚îÄ‚îÄ TECH GRID ‚îÄ‚îÄ */
  .tech-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .tech-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px;
    overflow: hidden;
    animation: fadeUp .5s ease both;
    transition: transform .2s, box-shadow .2s;
    box-shadow: 0 6px 24px rgba(0,0,0,0.14);
  }
  .tech-card:hover { transform: translateY(-3px); box-shadow: 0 14px 36px rgba(0,0,0,0.2); }
  .tech-card:nth-child(1) { animation-delay: .1s; }
  .tech-card:nth-child(2) { animation-delay: .15s; }
  .tech-card:nth-child(3) { animation-delay: .2s; }
  .tech-card:nth-child(4) { animation-delay: .25s; }

  .tech-header {
    padding: 1.2rem 1.4rem;
    display: flex; align-items: center; gap: 1rem;
    border-bottom: 1px solid var(--border);
    position: relative;
    background: var(--surface);
  }
  .tech-header::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .tech-card[data-tech="Tech1"] .tech-header::before { background: var(--t1); }
  .tech-card[data-tech="Tech2"] .tech-header::before { background: var(--t2); }
  .tech-card[data-tech="Tech3"] .tech-header::before { background: var(--t3); }
  .tech-card[data-tech="Tech4"] .tech-header::before { background: var(--t4); }

  .tech-avatar {
    width: 44px; height: 44px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 800;
    flex-shrink: 0;
  }
  .tech-card[data-tech="Tech1"] .tech-avatar { background: rgba(224,92,92,0.15); color: var(--t1); }
  .tech-card[data-tech="Tech2"] .tech-avatar { background: rgba(58,176,195,0.15); color: var(--t2); }
  .tech-card[data-tech="Tech3"] .tech-avatar { background: rgba(232,148,58,0.15); color: var(--t3); }
  .tech-card[data-tech="Tech4"] .tech-avatar { background: rgba(155,111,212,0.15); color: var(--t4); }

  .tech-name { font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700; color: var(--text); }
  .tech-status-badge {
    margin-left: auto;
    font-size: .7rem; font-weight: 600;
    padding: .25rem .65rem;
    border-radius: 999px;
    background: rgba(255,255,255,0.25);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.35);
  }

  .badge-waiting  { background: rgba(232,148,58,0.15);  color: #c97a20;  border: 1px solid rgba(232,148,58,0.35); }
  .badge-progress { background: rgba(58,176,195,0.15);  color: #1f8fa6;  border: 1px solid rgba(58,176,195,0.35); }
  .badge-done     { background: rgba(46,204,154,0.15);  color: #1a9970;  border: 1px solid rgba(46,204,154,0.35); }
  .badge-blocked  { background: rgba(224,92,92,0.15);   color: #c03535;  border: 1px solid rgba(224,92,92,0.35); }

  .tech-body { padding: 1rem; overflow: hidden; min-width: 0; }

  /* No mission state */
  .no-mission {
    text-align: center; padding: 1.5rem 0;
    color: var(--muted); font-size: .9rem; font-style: italic;
  }
  .no-mission-icon { font-size: 2rem; margin-bottom: .5rem; opacity: .3; }

  /* Mission display */
  .mission-title {
    font-family: 'DM Sans', sans-serif; font-size: .95rem; font-weight: 600;
    margin-bottom: .6rem; line-height: 1.4;
    color: #4a5568;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
  }
  .mission-meta {
    display: flex; flex-wrap: wrap; gap: .4rem;
    margin-bottom: 1rem;
    max-width: 100%;
    overflow: hidden;
  }
  .meta-chip {
    font-size: .72rem; color: var(--muted);
    background: #f0f4f8;
    padding: .2rem .6rem; border-radius: 6px;
    border: 1px solid rgba(0,0,0,0.08);
    display: flex; align-items: center; gap: .3rem;
    font-weight: 500;
  }

  .priority-badge {
    font-size: .7rem; font-weight: 600;
    padding: .2rem .65rem; border-radius: 6px;
  }
  .prio-haute    { background: rgba(224,92,92,0.15);  color: #c03535; font-weight:600; }
  .prio-normale  { background: rgba(58,176,195,0.15); color: #1f8fa6; font-weight:600; }
  .prio-basse    { background: rgba(46,204,154,0.15); color: #1a9970; font-weight:600; }

  /* Progress */
  .progress-section { margin-bottom: 1rem; }
  .progress-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: .5rem;
  }
  .progress-label { font-size: .82rem; color: #4a5568; font-weight: 600; }
  .progress-pct {
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 800;
  }
  .progress-bar {
    height: 7px; background: #e2e8f0; border-radius: 999px; overflow: hidden;
  }
  .progress-fill {
    height: 100%; border-radius: 999px;
    transition: width .4s ease, background .3s;
  }

  .progress-input {
    width: 100%; margin-top: .6rem;
    accent-color: var(--accent);
  }

  /* Status select */
  .status-select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid rgba(0,0,0,0.1);
    color: var(--text);
    border-radius: 8px;
    padding: .5rem .75rem;
    font-family: 'DM Sans', sans-serif;
    font-size: .85rem;
    cursor: pointer;
    margin-bottom: 1rem;
  }

  .tech-actions { display: flex; gap: .5rem; flex-wrap: wrap; }
  .tech-actions .btn { flex: 1; justify-content: center; font-size: .78rem; }

  /* ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ */
  .section-title {
    font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700;
    margin-bottom: 1rem;
    display: flex; align-items: center; gap: .6rem;
    color: var(--text);
  }
  .section-title::after {
    content: ''; flex: 1; height: 1px; 
    background: linear-gradient(to right, rgba(58,176,195,0.5), transparent);
  }

  /* History 4-column layout */
  .history-columns {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
  }
  @media (max-width: 900px) { .history-columns { grid-template-columns: repeat(2,1fr); } }
  @media (max-width: 500px) { .history-columns { grid-template-columns: 1fr; } }

  .history-col {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  }
  .history-col-header {
    padding: .75rem 1rem;
    display: flex; align-items: center; gap: .6rem;
    border-bottom: 1px solid rgba(0,0,0,0.07);
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: .9rem;
    background: linear-gradient(90deg, #e8f4f6, #f2f8f9);
    color: var(--text);
  }
  .history-col-dot {
    width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0;
  }
  .history-col-count {
    margin-left: auto;
    font-size: .72rem; color: #718096;
    background: #edf2f7;
    padding: .15rem .5rem; border-radius: 999px;
    border: 1px solid rgba(0,0,0,0.06);
  }
  .history-col-body { padding: .5rem; display: flex; flex-direction: column; gap: .4rem; }

  .history-item {
    background: var(--surface2);
    border: 1px solid rgba(0,0,0,0.07);
    border-radius: 10px;
    padding: .75rem .9rem;
    animation: fadeUp .3s ease both;
    transition: box-shadow .2s, transform .15s;
  }
  .history-item:hover { box-shadow: 0 4px 14px rgba(0,0,0,0.10); transform: translateX(2px); }
  .history-item-title { font-size: .92rem; font-weight: 700; margin-bottom: .35rem; color: #1a202c; letter-spacing: -.01em; }
  .history-item-meta { font-size: .76rem; color: #4a5568; font-weight: 500; display: flex; flex-wrap: wrap; gap: .35rem; align-items: center; }
  .history-item-badge {
    font-size: .65rem; font-weight: 600;
    padding: .15rem .5rem; border-radius: 5px;
  }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px);
    display: flex; align-items: center; justify-content: center;
    padding: 1rem;
    opacity: 0; pointer-events: none;
    transition: opacity .2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    padding: 2rem;
    width: 100%; max-width: 480px;
    max-height: 90vh; overflow-y: auto;
    transform: translateY(20px);
    transition: transform .2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-title {
    font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex; align-items: center; gap: .6rem;
    color: #2c3e50;
  }

  .form-group { margin-bottom: 1rem; }
  .form-label { font-size: .8rem; color: #64748b; margin-bottom: .4rem; display: block; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
  .form-input, .form-textarea, .form-select {
    width: 100%;
    background: #f8fafc;
    border: 1px solid rgba(0,0,0,0.12);
    color: var(--text);
    border-radius: 10px;
    padding: .65rem .9rem;
    font-family: 'DM Sans', sans-serif;
    font-size: .9rem;
    transition: border-color .2s;
  }
  .form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none; border-color: #2bbdc8; box-shadow: 0 0 0 3px rgba(43,189,200,0.15);
  }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }

  .modal-actions { display: flex; gap: .75rem; margin-top: 1.5rem; }
  .modal-actions .btn { flex: 1; justify-content: center; padding: .7rem; }

  /* ‚îÄ‚îÄ SETTINGS PANEL ‚îÄ‚îÄ */
  .settings-panel {
    position: fixed; top: 0; right: 0; bottom: 0; z-index: 150;
    width: 340px; max-width: 100%;
    background: var(--surface);
    border-left: 1px solid rgba(0,0,0,0.1);
    box-shadow: -8px 0 30px rgba(0,0,0,0.15);
    padding: 2rem 1.5rem;
    transform: translateX(100%);
    transition: transform .3s ease;
    overflow-y: auto;
  }
  .settings-panel.open { transform: translateX(0); }

  .settings-title {
    font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex; align-items: center; justify-content: space-between;
    color: #1a202c;
  }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast-container {
    position: fixed; bottom: 2rem; right: 2rem; z-index: 300;
    display: flex; flex-direction: column; gap: .5rem;
  }
  .toast {
    background: var(--surface);
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 12px;
    padding: .75rem 1.2rem;
    font-size: .85rem;
    color: var(--text);
    display: flex; align-items: center; gap: .6rem;
    animation: slideIn .3s ease;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    max-width: 320px;
  }
  .toast.success { border-left: 4px solid var(--done); }
  .toast.error   { border-left: 4px solid var(--blocked); }
  .toast.info    { border-left: 4px solid var(--accent); }

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    main { padding: 1rem; }
    .stats-bar { grid-template-columns: repeat(2, 1fr); }
    header { padding: 0 1rem; }
    .logo { font-size: 1.1rem; }
  }
  @media (max-width: 480px) {
    .stats-bar { grid-template-columns: 1fr 1fr; }
    .form-row { grid-template-columns: 1fr; }
  }

  .empty-history {
    text-align: center; padding: 2rem;
    color: var(--muted); font-style: italic;
    grid-column: 1 / -1;
  }

  /* scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }


/* DASHBOARD */

  :root {
    --bg: linear-gradient(145deg, #5b9ecf 0%, #7ec8c8 50%, #6ab4c8 100%);
    --surface: #ffffff;
    --surface2: #f4f6f9;
    --border: rgba(0,0,0,0.08);
    --text: #1a202c;
    --muted: #64748b;
    --accent: #3dbfd0;

    --c1: #e05c4b; /* Tech1 */
    --c2: #3dbfd0; /* Tech2 */
    --c3: #e8a838; /* Tech3 */
    --c4: #9b7fe8; /* Tech4 */

    --waiting:  #e8a838;
    --progress: #3dbfd0;
    --done:     #2ecc9a;
    --blocked:  #e05c4b;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: linear-gradient(145deg, #5b9ecf 0%, #7ec8c8 55%, #5bafc0 100%);
    background-attachment: fixed;
    color: var(--text);
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(255,255,255,0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(0,0,0,0.06);
    box-shadow: 0 2px 20px rgba(0,0,0,0.10);
    padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between;
    height: 64px;
  }

  .logo { font-family: 'Syne', sans-serif; font-size: 1.3rem; font-weight: 800; color: #1a202c; }
  .logo span { color: #3dbfd0; }
  .logo small { font-size: .7rem; font-weight: 500; color: #64748b; margin-left: .4rem; vertical-align: middle; }

  .header-right { display: flex; gap: .75rem; align-items: center; }

  .btn {
    font-family: 'DM Sans', sans-serif; font-size: .82rem; font-weight: 600;
    padding: .45rem 1rem; border-radius: 8px; border: none; cursor: pointer;
    transition: all .2s; display: flex; align-items: center; gap: .4rem;
  }
  .btn-back { background: #f1f5f9; color: #475569; }
  .btn-back:hover { background: #e2e8f0; }
  .btn-primary { background: #3dbfd0; color: #fff; box-shadow: 0 2px 8px rgba(61,191,208,0.3); }
  .btn-primary:hover { background: #2ea8b8; }
  .btn-danger { background: #fee2e2; color: #dc2626; }
  .btn-danger:hover { background: #fecaca; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  main { padding: 2rem; max-width: 1400px; margin: 0 auto; }

  /* ‚îÄ‚îÄ SETUP PANEL ‚îÄ‚îÄ */
  .dsetup-panel {
    background: #fff;
    border-radius: 18px;
    padding: 2rem;
    box-shadow: 0 6px 24px rgba(0,0,0,0.12);
    margin-bottom: 2rem;
    animation: fadeUp .4s ease both;
  }
  .dsetup-title {
    font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700;
    margin-bottom: 1.2rem; color: #1a202c;
    display: flex; align-items: center; gap: .6rem;
  }
  .dsetup-row { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
  .dsetup-group { display: flex; flex-direction: column; gap: .4rem; flex: 1; min-width: 200px; }
  .dsetup-label { font-size: .75rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
  .dsetup-input {
    padding: .6rem .9rem; border-radius: 10px;
    border: 1.5px solid #e2e8f0; background: #f7fafc;
    font-family: 'DM Sans', sans-serif; font-size: .9rem; color: #1a202c;
    transition: border-color .2s;
  }
  .dsetup-input:focus { outline: none; border-color: #3dbfd0; box-shadow: 0 0 0 3px rgba(61,191,208,0.15); }

  /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
  .dfilters-bar {
    background: #fff;
    border-radius: 16px;
    padding: 1.2rem 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    margin-bottom: 1.5rem;
    display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;
    animation: fadeUp .4s .05s ease both;
  }
  .dfilter-group { display: flex; flex-direction: column; gap: .3rem; }
  .dfilter-label { font-size: .72rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .04em; }
  .dfilter-select, .dfilter-input {
    padding: .45rem .8rem; border-radius: 8px;
    border: 1.5px solid #e2e8f0; background: #f7fafc;
    font-family: 'DM Sans', sans-serif; font-size: .85rem; color: #1a202c;
    cursor: pointer; transition: border-color .2s;
    min-width: 130px;
  }
  .dfilter-select:focus, .dfilter-input:focus { outline: none; border-color: #3dbfd0; }
  .dfilter-sep { color: #cbd5e1; font-size: 1.2rem; padding-bottom: .2rem; align-self: flex-end; }

  /* ‚îÄ‚îÄ KPI CARDS ‚îÄ‚îÄ */
  .dkpi-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
    margin-bottom: 1.5rem;
  }
  .dkpi-card {
    background: #fff; border-radius: 16px; padding: 1.4rem 1.6rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.09);
    border-top: 4px solid transparent;
    animation: fadeUp .4s ease both;
    transition: transform .2s, box-shadow .2s;
  }
  .dkpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.13); }
  .dkpi-card:nth-child(1) { border-top-color: #3dbfd0; animation-delay: .05s; }
  .dkpi-card:nth-child(2) { border-top-color: #2ecc9a; animation-delay: .10s; }
  .dkpi-card:nth-child(3) { border-top-color: #e8a838; animation-delay: .15s; }
  .dkpi-card:nth-child(4) { border-top-color: #e05c4b; animation-delay: .20s; }
  .dkpi-icon { font-size: 1.6rem; margin-bottom: .5rem; }
  .dkpi-label { font-size: .72rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: .05em; margin-bottom: .3rem; }
  .dkpi-value { font-family: 'Syne', sans-serif; font-size: 2.2rem; font-weight: 800; line-height: 1; }
  .dkpi-card:nth-child(1) .dkpi-value { color: #3dbfd0; }
  .dkpi-card:nth-child(2) .dkpi-value { color: #2ecc9a; }
  .dkpi-card:nth-child(3) .dkpi-value { color: #e8a838; }
  .dkpi-card:nth-child(4) .dkpi-value { color: #e05c4b; }
  .dkpi-sub { font-size: .75rem; color: #94a3b8; margin-top: .3rem; }

  /* ‚îÄ‚îÄ CHARTS GRID ‚îÄ‚îÄ */
  .dcharts-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;
    margin-bottom: 1.5rem;
  }
  .dchart-card {
    background: #fff; border-radius: 16px; padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.09);
    animation: fadeUp .4s .2s ease both;
  }
  .dchart-card.full { grid-column: 1 / -1; }
  .dchart-title {
    font-family: 'Syne', sans-serif; font-size: .95rem; font-weight: 700;
    color: #1a202c; margin-bottom: 1.2rem;
    display: flex; align-items: center; gap: .5rem;
  }
  .dchart-wrap { position: relative; height: 240px; }
  .dchart-wrap.tall { height: 300px; }

  /* ‚îÄ‚îÄ TECH TABLE ‚îÄ‚îÄ */
  .dtable-card {
    background: #fff; border-radius: 16px; padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.09);
    margin-bottom: 1.5rem;
    animation: fadeUp .4s .25s ease both;
  }
  .dtable-title {
    font-family: 'Syne', sans-serif; font-size: .95rem; font-weight: 700;
    color: #1a202c; margin-bottom: 1.2rem;
    display: flex; align-items: center; gap: .5rem;
  }
  table { width: 100%; border-collapse: collapse; }
  thead th {
    font-size: .72rem; font-weight: 700; color: #64748b;
    text-transform: uppercase; letter-spacing: .05em;
    padding: .6rem 1rem; text-align: left;
    border-bottom: 2px solid #f1f5f9;
  }
  tbody tr { transition: background .15s; }
  tbody tr:hover { background: #f8fafc; }
  tbody td {
    padding: .75rem 1rem; font-size: .88rem; color: #1a202c;
    border-bottom: 1px solid #f1f5f9;
  }
  .dtech-dot {
    width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: .5rem;
  }
  .dtd-num { font-family: 'Syne', sans-serif; font-weight: 700; }
  .dtd-bar { display: flex; align-items: center; gap: .6rem; }
  .td-bar-track { flex: 1; height: 6px; background: #f1f5f9; border-radius: 999px; overflow: hidden; }
  .td-bar-fill { height: 100%; border-radius: 999px; }

  /* ‚îÄ‚îÄ SEARCH TABLE ‚îÄ‚îÄ */
  .dsearch-results {
    background: #fff; border-radius: 16px; padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.09);
    animation: fadeUp .4s .3s ease both;
  }
  .dsearch-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 1rem; flex-wrap: wrap; gap: .5rem;
  }
  .dresult-count {
    font-size: .82rem; color: #64748b; font-weight: 500;
    background: #f1f5f9; padding: .25rem .75rem; border-radius: 999px;
  }
  .results-table-wrap { overflow-x: auto; }
  .dresults-table { min-width: 700px; }
  .dstatus-pill {
    font-size: .7rem; font-weight: 700; padding: .2rem .6rem;
    border-radius: 999px; white-space: nowrap;
  }
  .dpill-waiting  { background: rgba(232,168,56,0.15);  color: #b45309; }
  .dpill-progress { background: rgba(61,191,208,0.15);  color: #0e7490; }
  .dpill-done     { background: rgba(46,204,154,0.15);  color: #065f46; }
  .dpill-blocked  { background: rgba(224,92,75,0.15);   color: #991b1b; }

  /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
  .dempty-state {
    text-align: center; padding: 3rem 2rem; color: #94a3b8;
  }
  .dempty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: .5; }
  .dempty-title { font-family: 'Syne', sans-serif; font-size: 1.1rem; font-weight: 700; margin-bottom: .5rem; color: #64748b; }
  .dempty-sub { font-size: .88rem; }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .dloading {
    display: flex; align-items: center; justify-content: center; gap: .75rem;
    padding: 2rem; color: #64748b; font-size: .9rem;
  }
  .dspinner {
    width: 24px; height: 24px; border: 3px solid #e2e8f0;
    border-top-color: #3dbfd0; border-radius: 50%;
    animation: spin .7s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(14px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 900px) {
    .dkpi-grid { grid-template-columns: repeat(2,1fr); }
    .dcharts-grid { grid-template-columns: 1fr; }
    .dchart-card.full { grid-column: 1; }
  }
  @media (max-width: 500px) {
    main { padding: 1rem; }
    .dkpi-grid { grid-template-columns: 1fr 1fr; }
    header { padding: 0 1rem; }
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

</style>
</head>
<body>

<!-- TRACKER PAGE -->
<div class="page active" id="page-tracker">
<!-- HEADER -->
<header>
  <div class="logo">Tech<span>Track</span></div>
  <div class="header-right">
    <div class="clock" id="clock">--:--:--</div>
    <button class="btn" style="background:linear-gradient(135deg,#9b7fe8,#b89ff0);color:#fff;border:none;box-shadow:0 2px 8px rgba(155,127,232,0.35)" onclick="showDashboardPage()">üìä Dashboard</button>
    <button class="btn btn-success" onclick="sendReport()">üìß Envoyer rapport</button>
    <button class="btn" id="btnSyncSheets" onclick="loadFromSheets()" title="Importer missions depuis Mobile / Sheet" style="background:linear-gradient(135deg,#2bbdc8,#1fa8b3);color:#fff;border:none;box-shadow:0 2px 8px rgba(43,189,200,0.35);font-weight:600">üì± Sync Mobile</button>
    <button class="btn" id="btnFs" onclick="toggleFullscreen()" style="background:#475569;color:#fff;border:none;font-size:.95rem;padding:.4rem .85rem;border-radius:8px;cursor:pointer" title="Plein √©cran">‚õ∂</button>
    <button class="btn" id="btnFs" onclick="toggleFullscreen()" style="background:#475569;color:#fff;border:none;font-size:.85rem;padding:.4rem .85rem;border-radius:8px;cursor:pointer" title="Plein √©cran">‚õ∂</button>
    <button class="btn btn-ghost" onclick="toggleSettings()">‚öôÔ∏è</button>
    <button class="btn btn-danger" onclick="closeTechTrack()" title="Fermer TechTrack" style="background:rgba(224,92,92,0.15);color:#e05c5c;border:1.5px solid rgba(224,92,92,0.4);font-weight:600;padding:.45rem 1.1rem;border-radius:8px;display:flex;align-items:center;gap:.4rem">‚úï Fermer</button>
  </div>
</header>

<!-- MAIN -->
<main>
  <!-- Stats -->
  <div class="stats-bar" id="statsBar"></div>

  <!-- Tech Cards -->
  <div class="tech-grid" id="techGrid"></div>

  <!-- History -->
  <div class="section-title">üìã Historique du jour</div>
  <div class="history-columns" id="historyGrid"></div>
</main>

<!-- MODAL: Nouvelle Mission -->
<div class="modal-overlay" id="missionModal">
  <div class="modal">
    <div class="modal-title"><span id="modalTechIcon">üîß</span> <span id="modalTechName">Mission</span></div>
    <div class="form-group">
      <label class="form-label">Intitul√© de la mission *</label>
      <input class="form-input" id="fTitle" placeholder="Ex: R√©paration climatiseur salle A" required>
    </div>
    <div class="form-group">
      <label class="form-label">Lieu / Site</label>
      <input class="form-input" id="fSite" placeholder="Ex: B√¢timent B - 3√®me √©tage">
    </div>
    <div class="form-group">
      <label class="form-label">üìÖ Date de d√©but</label>
      <input class="form-input" id="fDate" type="date">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Heure de d√©but</label>
        <input class="form-input" id="fStart" type="time">
      </div>
      <div class="form-group">
        <label class="form-label">Heure de fin pr√©vue</label>
        <input class="form-input" id="fEnd" type="time">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Priorit√©</label>
      <select class="form-select" id="fPriority">
        <option value="Haute">üî¥ Haute</option>
        <option value="Normale" selected>üîµ Normale</option>
        <option value="Basse">üü¢ Basse</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Commentaire</label>
      <textarea class="form-textarea" id="fComment" placeholder="Remarques, observations..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn" style="background:#e2e8f0; color:#475569; font-weight:600; border:1.5px solid #cbd5e1" onclick="closeModal()">‚úï Annuler</button>
      <button class="btn btn-primary" onclick="saveMission()">‚úÖ Assigner la mission</button>
    </div>
  </div>
</div>

<!-- SETTINGS PANEL -->
<div class="settings-panel" id="settingsPanel">
  <div class="settings-title">
    Param√®tres
    <button class="btn" style="padding:.3rem .7rem; background:#b8c2cc; color:#1a202c; font-weight:700; border:none" onclick="toggleSettings()">‚úï</button>
  </div>

  <div class="form-group">
    <label class="form-label">üìß Email destinataire</label>
    <input class="form-input" id="sEmail" placeholder="responsable@entreprise.com">
  </div>

  <div class="form-group">
    <label class="form-label" style="font-weight:600; color:var(--accent)">EmailJS</label>
  </div>
  <div class="form-group">
    <label class="form-label">Service ID</label>
    <input class="form-input" id="sServiceId" placeholder="service_xxxxxxx">
  </div>
  <div class="form-group">
    <label class="form-label">Template ID</label>
    <input class="form-input" id="sTemplateId" placeholder="template_xxxxxxx">
  </div>
  <div class="form-group">
    <label class="form-label">Public Key</label>
    <input class="form-input" id="sPublicKey" placeholder="xxxxxxxxxxxxxxx">
  </div>

  <div class="form-group">
    <label class="form-label" style="font-weight:600; color:var(--accent)">Google Sheets</label>
  </div>
  <div class="form-group">
    <label class="form-label">Apps Script URL</label>
    <input class="form-input" id="sSheetUrl" placeholder="https://script.google.com/...">
  </div>

  <div class="form-group">
    <label class="form-label">‚è∞ Heure envoi auto</label>
    <input class="form-input" id="sAutoTime" type="time" value="18:00">
  </div>

  <button class="btn btn-primary" style="width:100%; justify-content:center; margin-top:.5rem" onclick="saveSettings()">üíæ Sauvegarder</button>
  <button class="btn btn-danger" style="width:100%; justify-content:center; margin-top:.5rem" onclick="clearDay()">üóëÔ∏è R√©initialiser la journ√©e</button>
</div>

<!-- TOASTS -->
<div class="toast-container" id="toastContainer"></div>
</div>

<!-- DASHBOARD PAGE -->
<div class="page" id="page-dashboard" style="background:linear-gradient(145deg,#5b9ecf 0%,#7ec8c8 55%,#5bafc0 100%);min-height:100vh">

<!-- HEADER DASHBOARD -->
<div style="position:sticky;top:0;z-index:100;background:rgba(255,255,255,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(0,0,0,0.06);box-shadow:0 2px 20px rgba(0,0,0,.10);padding:0 2rem;display:flex;align-items:center;justify-content:space-between;height:64px">
  <div style="font-family:'Syne',sans-serif;font-size:1.3rem;font-weight:800;color:#1a202c">Tech<span style="color:#3dbfd0">Track</span> <small style="font-size:.7rem;font-weight:500;color:#64748b;margin-left:.4rem;vertical-align:middle">Dashboard</small></div>
  <div style="display:flex;gap:.75rem;align-items:center">
    <button onclick="showTrackerPage()" style="font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;padding:.45rem 1rem;border-radius:8px;border:none;cursor:pointer;background:#f1f5f9;color:#475569">‚Üê Retour TechTrack</button>
    <button onclick="loadData()" style="font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;padding:.45rem 1rem;border-radius:8px;border:none;cursor:pointer;background:#3dbfd0;color:#fff;box-shadow:0 2px 8px rgba(61,191,208,.3)">üîÑ Charger</button>
    <button onclick="toggleFullscreen()" style="font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:600;padding:.45rem .8rem;border-radius:8px;border:none;cursor:pointer;background:#475569;color:#fff" title="Plein √©cran">‚õ∂</button>
    <button onclick="toggleFullscreen()" style="font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:600;padding:.45rem .8rem;border-radius:8px;border:none;cursor:pointer;background:#475569;color:#fff" title="Plein √©cran">‚õ∂</button>
    <button onclick="openPdfMailModal()" style="font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;padding:.45rem 1rem;border-radius:8px;border:none;cursor:pointer;background:#e05c4b;color:#fff;box-shadow:0 2px 8px rgba(224,92,75,.3)">üìß Envoyer PDF</button>
    <button onclick="openPdfMailModal()" style="font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;padding:.45rem 1rem;border-radius:8px;border:none;cursor:pointer;background:#e05c4b;color:#fff;box-shadow:0 2px 8px rgba(224,92,75,.3)">üìß Envoyer PDF</button>
  </div>
</div>

<!-- CONTENU DASHBOARD -->
<div style="padding:2rem;max-width:1400px;margin:0 auto">

  <!-- APPS SCRIPT SETUP CARD -->
  <div id="d_appsSetup" style="background:#fff;border-radius:16px;padding:1.5rem 2rem;box-shadow:0 6px 24px rgba(0,0,0,.12);margin-bottom:1.5rem;border-left:5px solid #e8a838">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem">
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:#1a202c;margin-bottom:.3rem">‚öôÔ∏è Configuration Apps Script requise</div>
        <div style="font-size:.85rem;color:#64748b;line-height:1.6">
          Ajoutez la fonction <code style="background:#f1f5f9;padding:.1rem .4rem;border-radius:4px;font-size:.82rem;color:#e05c4b">doGet</code> dans votre Apps Script
          puis cr√©ez un <strong>nouveau d√©ploiement</strong>.
        </div>
      </div>
      <button onclick="document.getElementById('d_codePanel').style.display=document.getElementById('d_codePanel').style.display==='none'?'block':'none'"
        style="font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;padding:.5rem 1.1rem;border-radius:8px;border:none;cursor:pointer;background:#e8a838;color:#fff;white-space:nowrap">
        üìã Voir le code √† copier
      </button>
    </div>
    <div id="d_codePanel" style="display:none;margin-top:1.2rem">
      <div style="background:#1e293b;border-radius:10px;padding:1.2rem;position:relative">
        <button onclick="navigator.clipboard.writeText(document.getElementById('d_codeText').innerText).then(()=>dShowToast('‚úÖ Code copi√© !'))"
          style="position:absolute;top:.7rem;right:.7rem;font-size:.75rem;background:#3dbfd0;color:#fff;border:none;border-radius:6px;padding:.3rem .8rem;cursor:pointer;font-weight:600">
          üìã Copier
        </button>
        <pre id="d_codeText" style="font-family:monospace;font-size:.8rem;color:#e2e8f0;white-space:pre-wrap;margin:0;line-height:1.7;padding-right:4rem">function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const data  = sheet.getDataRange().getValues();
  const cb    = e &amp;&amp; e.parameter &amp;&amp; e.parameter.callback;
  const json  = JSON.stringify({ data: data });
  if (cb) {
    return ContentService.createTextOutput(cb + '(' + json + ')')
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService.createTextOutput(json)
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const data  = JSON.parse(e.postData.contents);
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const last  = sheet.getLastRow();
  let foundRow = -1;
  if (data.missionId &amp;&amp; last > 1) {
    const ids = sheet.getRange(2, 1, last - 1, 1).getValues();
    for (let i = 0; i &lt; ids.length; i++) {
      if (ids[i][0] === data.missionId) { foundRow = i + 2; break; }
    }
  }
  const row = [data.missionId, data.date, data.tech,
    data.title, data.site, data.priority, data.status,
    (data.pct !== undefined ? data.pct + '%' : ''), data.comment, data.timestamp];
  if (foundRow > 0) sheet.getRange(foundRow, 1, 1, row.length).setValues([row]);
  else sheet.appendRow(row);
  return ContentService.createTextOutput(JSON.stringify({status:'success'}))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
      </div>
      <div style="margin-top:1rem;background:#fef3c7;border-radius:10px;padding:1rem 1.2rem;font-size:.82rem;color:#92400e;line-height:1.8">
        <strong>üìå √âtapes pour d√©ployer :</strong><br>
        1. Ouvrez votre Apps Script (Extensions ‚Üí Apps Script)<br>
        2. <strong>Remplacez tout le code</strong> par celui ci-dessus<br>
        3. Cliquez <strong>D√©ployer ‚Üí Nouveau d√©ploiement</strong> (pas "G√©rer les d√©ploiements")<br>
        4. Type : <strong>Application Web</strong> ‚Äî Ex√©cuter en tant que : <strong>Moi</strong> ‚Äî Acc√®s : <strong>Tout le monde</strong><br>
        5. Copiez la nouvelle URL et collez-la dans ‚öôÔ∏è Param√®tres de TechTrack<br>
        <em>‚ö†Ô∏è Chaque modification du code n√©cessite un NOUVEAU d√©ploiement pour √™tre prise en compte</em>
      </div>
    </div>
  </div>

  <!-- KPI -->
  <div id="d_kpi" style="display:none;grid-template-columns:repeat(4,1fr);gap:1.25rem;margin-bottom:1.5rem"></div>

  <!-- FILTRES -->
  <div id="d_filters" style="display:none;background:#fff;border-radius:16px;padding:1.2rem 1.5rem;box-shadow:0 4px 16px rgba(0,0,0,.10);margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem;align-items:flex-end">
    <div style="display:flex;flex-direction:column;gap:.3rem">
      <label style="font-size:.72rem;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:.04em">P√©riode</label>
      <select id="d_period" onchange="dashPeriodChange()" style="padding:.45rem .8rem;border-radius:8px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.85rem;color:#1a202c;cursor:pointer;min-width:130px">
        <option value="week">Cette semaine</option>
        <option value="month" selected>Ce mois</option>
        <option value="year">Cette ann√©e</option>
        <option value="custom">Personnalis√©</option>
      </select>
    </div>
    <div id="d_customdates" style="display:none;gap:.5rem;align-items:flex-end">
      <div style="display:flex;flex-direction:column;gap:.3rem">
        <label style="font-size:.72rem;font-weight:600;color:#64748b;text-transform:uppercase">Du</label>
        <input id="d_from" type="date" onchange="dashApplyFilters()" style="padding:.45rem .8rem;border-radius:8px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.85rem">
      </div>
      <span style="color:#cbd5e1;font-size:1.2rem;padding-bottom:.2rem">‚Üí</span>
      <div style="display:flex;flex-direction:column;gap:.3rem">
        <label style="font-size:.72rem;font-weight:600;color:#64748b;text-transform:uppercase">Au</label>
        <input id="d_to" type="date" onchange="dashApplyFilters()" style="padding:.45rem .8rem;border-radius:8px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.85rem">
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:.3rem">
      <label style="font-size:.72rem;font-weight:600;color:#64748b;text-transform:uppercase">Technicien</label>
      <select id="d_tech" onchange="dashApplyFilters()" style="padding:.45rem .8rem;border-radius:8px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.85rem;color:#1a202c;cursor:pointer;min-width:100px">
        <option value="all">Tous</option>
        <option value="Tech1">Tech1</option>
        <option value="Tech2">Tech2</option>
        <option value="Tech3">Tech3</option>
        <option value="Tech4">Tech4</option>
      </select>
    </div>
    <div style="display:flex;flex-direction:column;gap:.3rem">
      <label style="font-size:.72rem;font-weight:600;color:#64748b;text-transform:uppercase">Statut</label>
      <select id="d_status" onchange="dashApplyFilters()" style="padding:.45rem .8rem;border-radius:8px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.85rem;color:#1a202c;cursor:pointer;min-width:130px">
        <option value="all">Tous</option>
        <option value="done">‚úÖ Termin√©</option>
        <option value="progress">üîß En cours</option>
        <option value="waiting">‚è≥ En attente</option>
        <option value="blocked">‚ö†Ô∏è Bloqu√©</option>
      </select>
    </div>
    <div style="display:flex;flex-direction:column;gap:.3rem">
      <label style="font-size:.72rem;font-weight:600;color:#64748b;text-transform:uppercase">Recherche</label>
      <input id="d_search" type="text" placeholder="Mission, site..." oninput="dashApplyFilters()" style="padding:.45rem .8rem;border-radius:8px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.85rem;min-width:180px">
    </div>
    <button onclick="dashReset()" style="font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;padding:.45rem .9rem;border-radius:8px;border:none;cursor:pointer;background:#fee2e2;color:#dc2626;align-self:flex-end">‚úï Reset</button>
  </div>

  <!-- CHARTS -->
  <div id="d_charts" style="display:none;grid-template-columns:1fr 1fr;gap:1.25rem;margin-bottom:1.5rem">
    <div style="background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 4px 16px rgba(0,0,0,.09)">
      <div style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:#1a202c;margin-bottom:1.2rem">üìä Missions par statut</div>
      <div style="position:relative;height:240px"><canvas id="d_chartStatus"></canvas></div>
    </div>
    <div style="background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 4px 16px rgba(0,0,0,.09)">
      <div style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:#1a202c;margin-bottom:1.2rem">üë§ Missions par technicien</div>
      <div style="position:relative;height:240px"><canvas id="d_chartTech"></canvas></div>
    </div>
    <div style="background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 4px 16px rgba(0,0,0,.09);grid-column:1/-1">
      <div style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:#1a202c;margin-bottom:1.2rem">üìÖ √âvolution par semaine</div>
      <div style="position:relative;height:300px"><canvas id="d_chartWeekly"></canvas></div>
    </div>
  </div>

  <!-- TABLE TECH -->
  <div id="d_table" style="display:none;background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 4px 16px rgba(0,0,0,.09);margin-bottom:1.5rem">
    <div style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:#1a202c;margin-bottom:1.2rem">üìã D√©tail par technicien</div>
    <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse" id="d_techTable">
      <thead><tr>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Technicien</th>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Total</th>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">‚úÖ Termin√©es</th>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">üîß En cours</th>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">‚è≥ Attente</th>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">‚ö†Ô∏è Bloqu√©es</th>
        <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.05em;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Taux r√©ussite</th>
      </tr></thead>
      <tbody id="d_techBody"></tbody>
    </table></div>
  </div>

  <!-- LISTE MISSIONS -->
  <div id="d_list" style="display:none;background:#fff;border-radius:16px;padding:1.5rem;box-shadow:0 4px 16px rgba(0,0,0,.09)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem">
      <div style="font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:#1a202c">üîç Missions filtr√©es</div>
      <span id="d_count" style="font-size:.82rem;color:#64748b;font-weight:500;background:#f1f5f9;padding:.25rem .75rem;border-radius:999px">0 r√©sultats</span>
    </div>
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;min-width:700px" id="d_listTable">
        <thead><tr>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">ID</th>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Date</th>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Tech</th>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Mission</th>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Site</th>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">Statut</th>
          <th style="font-size:.72rem;font-weight:700;color:#64748b;text-transform:uppercase;padding:.6rem 1rem;text-align:left;border-bottom:2px solid #f1f5f9">%</th>
        </tr></thead>
        <tbody id="d_listBody"></tbody>
      </table>
    </div>
  </div>

  <!-- MODAL PDF MAIL -->
  <div id="d_pdfModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:20px;padding:2rem;width:90%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative">
      <button onclick="document.getElementById('d_pdfModal').style.display='none'" style="position:absolute;top:1rem;right:1rem;background:#f1f5f9;border:none;border-radius:50%;width:32px;height:32px;font-size:1rem;cursor:pointer;color:#475569">‚úï</button>
      <div style="font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:800;color:#1a202c;margin-bottom:.3rem">üìß Envoyer le dashboard par mail</div>
      <div id="d_pdfPeriodLabel" style="font-size:.82rem;color:#64748b;margin-bottom:1.5rem"></div>

      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label style="font-size:.75rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.4rem">Destinataire principal</label>
          <input id="d_mailTo" type="email" style="width:100%;padding:.6rem .9rem;border-radius:10px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#1a202c;box-sizing:border-box" placeholder="email@exemple.com">
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.4rem">Adresse suppl√©mentaire (optionnel)</label>
          <input id="d_mailCc" type="email" style="width:100%;padding:.6rem .9rem;border-radius:10px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#1a202c;box-sizing:border-box" placeholder="cc@exemple.com">
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.4rem">Sujet</label>
          <input id="d_mailSubject" type="text" style="width:100%;padding:.6rem .9rem;border-radius:10px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#1a202c;box-sizing:border-box">
        </div>
      </div>

      <div id="d_pdfStatus" style="display:none;margin-top:1rem;padding:.75rem 1rem;border-radius:10px;font-size:.85rem;font-weight:500"></div>

      <div style="display:flex;gap:.75rem;margin-top:1.5rem;justify-content:flex-end">
        <button onclick="document.getElementById('d_pdfModal').style.display='none'" style="font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;padding:.55rem 1.2rem;border-radius:10px;border:none;cursor:pointer;background:#f1f5f9;color:#475569">Annuler</button>
        <button onclick="downloadDashboardPdf()" style="font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;padding:.55rem 1.2rem;border-radius:10px;border:none;cursor:pointer;background:#e8a838;color:#fff">‚¨áÔ∏è T√©l√©charger PDF</button>
        <button onclick="sendDashboardPdf()" style="font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;padding:.55rem 1.2rem;border-radius:10px;border:none;cursor:pointer;background:#e05c4b;color:#fff">üìß Envoyer</button>
      </div>
    </div>
  </div>

  <!-- ETAT VIDE -->
  <!-- MODAL PDF MAIL -->
  <div id="d_pdfModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:center;justify-content:center">
    <div style="background:#fff;border-radius:20px;padding:2rem;width:90%;max-width:480px;box-shadow:0 20px 60px rgba(0,0,0,.3);position:relative">
      <button onclick="document.getElementById('d_pdfModal').style.display='none'" style="position:absolute;top:1rem;right:1rem;background:#f1f5f9;border:none;border-radius:50%;width:32px;height:32px;font-size:1rem;cursor:pointer;color:#475569">‚úï</button>
      <div style="font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:800;color:#1a202c;margin-bottom:.3rem">üìß Envoyer le dashboard par mail</div>
      <div id="d_pdfPeriodLabel" style="font-size:.82rem;color:#64748b;margin-bottom:1.5rem"></div>
      <div style="display:flex;flex-direction:column;gap:1rem">
        <div>
          <label style="font-size:.75rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.4rem">Destinataire principal</label>
          <input id="d_mailTo" type="email" style="width:100%;padding:.6rem .9rem;border-radius:10px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#1a202c;box-sizing:border-box" placeholder="email@exemple.com">
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.4rem">Adresse suppl√©mentaire (optionnel)</label>
          <input id="d_mailCc" type="email" style="width:100%;padding:.6rem .9rem;border-radius:10px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#1a202c;box-sizing:border-box" placeholder="cc@exemple.com">
        </div>
        <div>
          <label style="font-size:.75rem;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:.4rem">Sujet</label>
          <input id="d_mailSubject" type="text" style="width:100%;padding:.6rem .9rem;border-radius:10px;border:1.5px solid #e2e8f0;background:#f7fafc;font-family:'DM Sans',sans-serif;font-size:.9rem;color:#1a202c;box-sizing:border-box">
        </div>
      </div>
      <div id="d_pdfStatus" style="display:none;margin-top:1rem;padding:.75rem 1rem;border-radius:10px;font-size:.85rem;font-weight:500"></div>
      <div style="display:flex;gap:.75rem;margin-top:1.5rem;justify-content:flex-end;flex-wrap:wrap">
        <button onclick="document.getElementById('d_pdfModal').style.display='none'" style="font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;padding:.55rem 1.2rem;border-radius:10px;border:none;cursor:pointer;background:#f1f5f9;color:#475569">Annuler</button>
        <button onclick="downloadDashboardPdf()" style="font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;padding:.55rem 1.2rem;border-radius:10px;border:none;cursor:pointer;background:#e8a838;color:#fff">‚¨áÔ∏è PDF local</button>
        <button onclick="sendDashboardPdf()" style="font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;padding:.55rem 1.2rem;border-radius:10px;border:none;cursor:pointer;background:#e05c4b;color:#fff">üìß Envoyer par mail</button>
      </div>
    </div>
  </div>

  <div id="d_empty" style="text-align:center;padding:3rem 2rem;color:#94a3b8">
    <div style="font-size:3rem;margin-bottom:1rem;opacity:.5">üìä</div>
    <div style="font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;color:#fff;margin-bottom:.5rem">Cliquez sur Charger</div>
    <div style="font-size:.88rem;color:rgba(255,255,255,.7)">Les donn√©es TechTrack seront charg√©es automatiquement</div>
  </div>

</div>
</div>
<script>
/* ‚ïê‚ïê NAVIGATION ‚ïê‚ïê */
function showTrackerPage() {
  document.getElementById('page-tracker').classList.add('active');
  document.getElementById('page-dashboard').classList.remove('active');
  document.title = 'TechTrack';
}

/* ‚ïê‚ïê TRACKER JS ‚ïê‚ïê */
// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TECHS = ['Tech1','Tech2','Tech3','Tech4'];
const COLORS = { Tech1:'#ff6b6b', Tech2:'#4ecdc4', Tech3:'#ffe66d', Tech4:'#a78bfa' };
const INITIALS = { Tech1:'T1', Tech2:'T2', Tech3:'T3', Tech4:'T4' };

const STATUS_LABELS = {
  waiting:  '‚è≥ En attente',
  progress: 'üîß En cours',
  done:     '‚úÖ Termin√©',
  blocked:  '‚ö†Ô∏è Bloqu√©'
};

let state = {
  missions: {},   // { Tech1: [{id, title, site, start, end, priority, comment, status, pct}] }
  history: [],    // [{id, tech, title, site, priority, status, pct, comment, completedAt}]
  settings: {
    email: '', serviceId: '', templateId: '', publicKey: '', sheetUrl: '', autoTime: '18:00'
  }
};

let currentTech = null;
let currentMissionId = null; // for editing existing mission
let autoSendDone = false;

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2,5);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function init() {
  loadState();
  renderStats();
  renderTechGrid();
  renderHistory();
  loadSettingsForm();
  startClock();
}

function loadState() {
  const saved = localStorage.getItem('techtrack_state');
  if (saved) {
    const parsed = JSON.parse(saved);
    const today = new Date().toDateString();
    if (parsed.date !== today) {
      state.missions = {};
      state.history = [];
      state.settings = parsed.settings || state.settings;
    } else {
      state = { ...state, ...parsed };
    }
  }
  TECHS.forEach(t => { if (!state.missions[t]) state.missions[t] = []; });
}

function saveState() {
  localStorage.setItem('techtrack_state', JSON.stringify({
    ...state, date: new Date().toDateString()
  }));
}

// ‚îÄ‚îÄ‚îÄ CLOCK & AUTO-SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startClock() {
  function tick() {
    const now = new Date();
    document.getElementById('clock').textContent = now.toLocaleTimeString('fr-FR');

    // Auto-send check
    const hm = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    if (hm === state.settings.autoTime && !autoSendDone) {
      autoSendDone = true;
      sendReport(true);
    }
    if (hm !== state.settings.autoTime) autoSendDone = false;
  }
  tick();
  setInterval(tick, 1000);
}

// ‚îÄ‚îÄ‚îÄ RENDER STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const missions = Object.values(state.missions).flat();
  const active   = missions.filter(m => m.status === 'progress').length;
  const done     = state.history.filter(h => h.status === 'done').length;
  const blocked  = missions.filter(m => m.status === 'blocked').length;
  const total    = missions.length + state.history.length;

  const cards = [
    { icon:'üîß', label:'En cours',       value: active,  color:'#2a8a96', bg:'rgba(58,172,184,0.15)',  stripe:'#3aacb8' },
    { icon:'‚úÖ', label:'Termin√©es',      value: done,    color:'#1e8a52', bg:'rgba(58,184,122,0.15)',  stripe:'#3ab87a' },
    { icon:'‚ö†Ô∏è', label:'Bloqu√©es',       value: blocked, color:'#c03030', bg:'rgba(224,80,80,0.12)',   stripe:'#e05050' },
    { icon:'üìã', label:'Total missions', value: total,   color:'#6a4aab', bg:'rgba(142,107,191,0.15)', stripe:'#8e6bbf' },
  ];

  document.getElementById('statsBar').innerHTML = cards.map(c => `
    <div class="stat-card" style="border-top: 4px solid ${c.stripe}">
      <div>
        <div class="stat-icon" style="background:${c.bg}; color:${c.color}; margin-bottom:.5rem">${c.icon}</div>
        <div class="stat-label">${c.label}</div>
        ${c.sub ? `<div class="stat-sub">${c.sub}</div>` : ''}
      </div>
      <div class="stat-value" style="color:${c.stripe}">${c.value}</div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ RENDER TECH GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTechGrid() {
  document.getElementById('techGrid').innerHTML = TECHS.map(tech => {
    const missions = state.missions[tech] || [];
    const hasActive = missions.length > 0;
    const statusClass = hasActive ? `badge-${missions[0].status}` : 'badge-waiting';
    const statusLabel = hasActive ? `${missions.length} mission${missions.length>1?'s':''}` : '‚è≥ Libre';

    const body = hasActive
      ? missions.map((m, i) => {
          const statusColor = { waiting:'#e8943a', progress:'#3ab0c3', done:'#2ecc9a', blocked:'#e05c5c' }[m.status] || '#3ab0c3';
          const statusBgTint = { waiting:'rgba(232,148,58,0.06)', progress:'rgba(58,176,195,0.06)', done:'rgba(46,204,154,0.06)', blocked:'rgba(224,92,92,0.06)' }[m.status] || 'transparent';
          return `
          <div style="
            background: ${statusBgTint};
            border: 1px solid rgba(0,0,0,0.07);
            border-left: 4px solid ${statusColor};
            border-radius: 12px;
            padding: 1rem 1rem 1rem 1.1rem;
            margin-bottom: .65rem;
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          ">
            <div style="display:flex; align-items:center; gap:.5rem; margin-bottom:.85rem;">
              <span style="font-size:.75rem; font-family:'DM Sans',sans-serif; font-weight:700; background:${statusColor}; color:#fff; padding:.28rem .75rem; border-radius:999px; letter-spacing:.02em; box-shadow:0 2px 6px rgba(0,0,0,0.12); white-space:nowrap">Mission ${i+1}</span>
              <span style="font-size:.75rem; font-family:'DM Sans',sans-serif; font-weight:700; color:#fff; background:#3dbfd0; padding:.28rem .75rem; border-radius:7px; letter-spacing:.05em; box-shadow:0 2px 6px rgba(61,191,208,0.3); white-space:nowrap">#${m.id ? m.id.toUpperCase().slice(-6) : '------'}</span>
            </div>
            ${renderMissionBody(tech, m)}
          </div>
        `}).join('')
      : `<div class="no-mission"><div class="no-mission-icon">üõ†Ô∏è</div>Aucune mission en cours</div>`;

    return `
      <div class="tech-card" data-tech="${tech}">
        <div class="tech-header">
          <div class="tech-avatar">${INITIALS[tech]}</div>
          <div><div class="tech-name">${tech}</div></div>
          <span class="tech-status-badge ${statusClass}">${statusLabel}</span>
        </div>
        <div class="tech-body">
          ${body}
          <div class="tech-actions" style="margin-top:.75rem">
            <button class="btn btn-primary" onclick="openModal('${tech}')">‚ûï Nouvelle mission</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderMissionBody(tech, m) {
  const prioClass = { Haute:'prio-haute', Normale:'prio-normale', Basse:'prio-basse' }[m.priority] || 'prio-normale';
  const fillColor = { waiting:'#e8a020', progress:'#3bbfb0', done:'#27ae60', blocked:'#e05c3a' }[m.status];

  return `
    <div class="mission-title">${m.title}</div>
    <div class="mission-meta">
      ${m.missionDate ? `<span class="meta-chip">üìÖ ${new Date(m.missionDate).toLocaleDateString('fr-FR')}</span>` : ''}
      ${m.site ? `<span class="meta-chip" style="white-space:normal; overflow-wrap:break-word; word-break:break-word; max-width:100%">üìç ${m.site}</span>` : ''}
      ${m.start ? `<span class="meta-chip">üïê ${m.start}${m.end ? ' ‚Üí '+m.end : ''}</span>` : ''}
      <span class="priority-badge ${prioClass}">${m.priority}</span>
    </div>
    ${m.comment ? `<div style="margin-bottom:.75rem; font-size:.75rem; color:#2d3748; background:#edf2f7; padding:.3rem .75rem; border-radius:7px; border:1px solid rgba(0,0,0,0.08); font-weight:600; white-space:normal; overflow-wrap:break-word; word-break:break-word; max-width:100%; display:block">üí¨ ${m.comment}</div>` : ''}

    <div class="progress-section">
      <div class="progress-header">
        <span class="progress-label">Avancement</span>
        <span class="progress-pct" style="color:${fillColor}">${m.pct}%</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${m.pct}%; background:${fillColor}"></div>
      </div>
      <input type="range" class="progress-input" min="0" max="100" value="${m.pct}"
        oninput="updatePct('${tech}', '${m.id}', this.value)">
    </div>

    <select class="status-select" onchange="updateStatus('${tech}', '${m.id}', this.value)">
      ${Object.entries(STATUS_LABELS).map(([k,v]) =>
        `<option value="${k}" ${m.status===k?'selected':''}>${v}</option>`
      ).join('')}
    </select>

    <div class="tech-actions" style="margin-bottom:.25rem">
      <button class="btn" style="font-size:.75rem; background:#e8a838; color:#fff; border:none; box-shadow:0 2px 6px rgba(232,168,56,0.35)" onclick="editMission('${tech}','${m.id}')">‚úèÔ∏è Modifier</button>
      <button class="btn btn-danger" style="font-size:.75rem" onclick="completeMission('${tech}','${m.id}')">üèÅ Terminer</button>
    </div>
  `;
}

// ‚îÄ‚îÄ‚îÄ RENDER HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistory() {
  const grid = document.getElementById('historyGrid');
  const statusColor = { done:'#2ecc9a', blocked:'#e05c5c', waiting:'#e8943a', progress:'#3ab0c3' };
  const statusBg    = { done:'rgba(46,204,154,0.12)', blocked:'rgba(224,92,92,0.12)', waiting:'rgba(232,148,58,0.12)', progress:'rgba(58,176,195,0.12)' };

  grid.innerHTML = TECHS.map(tech => {
    const missions = state.history.filter(h => h.tech === tech);
    const color = COLORS[tech];
    const items = missions.length
      ? missions.map(h => `
          <div class="history-item" style="border-left: 3px solid ${statusColor[h.status] || '#3dbfd0'}">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:.25rem">
              <div class="history-item-title" style="margin-bottom:0">${h.title}</div>
              <span style="font-size:1rem; color:#ffffff; background:#3dbfd0; border:none; padding:.35rem .9rem; border-radius:8px; font-family:'Syne',sans-serif; font-weight:800; flex-shrink:0; margin-left:.5rem; letter-spacing:.08em; box-shadow:0 2px 8px rgba(61,191,208,0.35)">#${h.id ? h.id.toUpperCase().slice(-6) : '------'}</span>
            </div>
            <div class="history-item-meta">
              ${h.missionDate ? `<span>üìÖ ${new Date(h.missionDate).toLocaleDateString('fr-FR')}</span>` : ''}
              ${h.site ? `<span>üìç ${h.site}</span>` : ''}
              <span class="history-item-badge" style="background:${statusBg[h.status]||''}; color:${statusColor[h.status]||'#fff'}">${STATUS_LABELS[h.status]}</span>
              <span>${h.pct}%</span>
              ${h.completedAt ? `<span>üïê ${h.completedAt}</span>` : ''}
            </div>
          </div>
        `).join('')
      : `<div style="padding:.75rem; font-size:.8rem; color:var(--muted); font-style:italic; text-align:center">Aucune mission</div>`;

    return `
      <div class="history-col">
        <div class="history-col-header">
          <div class="history-col-dot" style="background:${color}"></div>
          ${tech}
          <span class="history-col-count">${missions.length} mission${missions.length>1?'s':''}</span>
        </div>
        <div class="history-col-body">${items}</div>
      </div>
    `;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(tech, missionId = null) {
  currentTech = tech;
  currentMissionId = missionId;
  const isEdit = missionId !== null;
  document.getElementById('modalTechName').textContent = `Mission ‚Äî ${tech}`;
  document.getElementById('modalTechIcon').textContent = isEdit ? '‚úèÔ∏è' : 'üîß';

  let d = {};
  if (isEdit) {
    d = (state.missions[tech] || []).find(m => m.id === missionId) || {};
  }
  const todayStr = new Date().toISOString().split('T')[0];
  document.getElementById('fTitle').value    = d.title    || '';
  document.getElementById('fSite').value     = d.site     || '';
  document.getElementById('fDate').value     = d.missionDate || todayStr;
  document.getElementById('fStart').value    = d.start    || '';
  document.getElementById('fEnd').value      = d.end      || '';
  document.getElementById('fPriority').value = d.priority || 'Normale';
  document.getElementById('fComment').value  = d.comment  || '';

  document.getElementById('missionModal').classList.add('open');
}

function closeModal() {
  document.getElementById('missionModal').classList.remove('open');
  currentTech = null;
  currentMissionId = null;
}

function saveMission() {
  const title = document.getElementById('fTitle').value.trim();
  if (!title) { toast('‚ö†Ô∏è Intitul√© requis', 'error'); return; }

  const techName = currentTech;
  const missionId = currentMissionId;

  if (!state.missions[techName]) state.missions[techName] = [];

  let savedMission;
  if (missionId) {
    // Edit existing
    const idx = state.missions[techName].findIndex(m => m.id === missionId);
    if (idx >= 0) {
      state.missions[techName][idx] = {
        ...state.missions[techName][idx],
        title,
        site:        document.getElementById('fSite').value.trim(),
        missionDate: document.getElementById('fDate').value,
        start:       document.getElementById('fStart').value,
        end:         document.getElementById('fEnd').value,
        priority:    document.getElementById('fPriority').value,
        comment:     document.getElementById('fComment').value.trim(),
      };
      savedMission = state.missions[techName][idx];
    }
  } else {
    // New mission
    savedMission = {
      id:          genId(),
      title,
      site:        document.getElementById('fSite').value.trim(),
      missionDate: document.getElementById('fDate').value,
      start:       document.getElementById('fStart').value,
      end:         document.getElementById('fEnd').value,
      priority:    document.getElementById('fPriority').value,
      comment:     document.getElementById('fComment').value.trim(),
      status:      'waiting',
      pct:         0,
    };
    state.missions[techName].push(savedMission);
  }

  saveState();
  renderAll();
  closeModal();
  toast(`‚úÖ Mission assign√©e √† ${techName}`, 'success');
  if (savedMission) syncToSheets(techName, savedMission);
}

function editMission(tech, missionId) {
  openModal(tech, missionId);
}

function completeMission(tech, missionId) {
  const missions = state.missions[tech] || [];
  const idx = missions.findIndex(m => m.id === missionId);
  if (idx < 0) return;
  const m = missions[idx];
  state.history.push({
    ...m, tech,
    completedAt: new Date().toLocaleTimeString('fr-FR', {hour:'2-digit',minute:'2-digit'})
  });
  syncToSheets(tech, { ...m, status: m.status });
  state.missions[tech].splice(idx, 1);
  saveState();
  renderAll();
  toast(`üèÅ Mission "${m.title}" archiv√©e`, 'info');
}

let pctSyncTimer = {};
function updatePct(tech, missionId, val) {
  const m = (state.missions[tech] || []).find(m => m.id === missionId);
  if (!m) return;
  m.pct = parseInt(val);
  saveState();
  renderTechGrid();
  renderStats();
  clearTimeout(pctSyncTimer[missionId]);
  pctSyncTimer[missionId] = setTimeout(() => syncToSheets(tech, m), 1500);
}

function updateStatus(tech, missionId, val) {
  const m = (state.missions[tech] || []).find(m => m.id === missionId);
  if (!m) return;
  m.status = val;
  if (val === 'done') m.pct = 100;
  saveState();
  renderAll();
  syncToSheets(tech, m);
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSettings() {
  document.getElementById('settingsPanel').classList.toggle('open');
}

function loadSettingsForm() {
  const s = state.settings;
  document.getElementById('sEmail').value      = s.email      || '';
  document.getElementById('sServiceId').value  = s.serviceId  || '';
  document.getElementById('sTemplateId').value = s.templateId || '';
  document.getElementById('sPublicKey').value  = s.publicKey  || '';
  document.getElementById('sSheetUrl').value   = s.sheetUrl   || '';
  document.getElementById('sAutoTime').value   = s.autoTime   || '18:00';
}

function saveSettings() {
  state.settings = {
    email:      document.getElementById('sEmail').value.trim(),
    serviceId:  document.getElementById('sServiceId').value.trim(),
    templateId: document.getElementById('sTemplateId').value.trim(),
    publicKey:  document.getElementById('sPublicKey').value.trim(),
    sheetUrl:   document.getElementById('sSheetUrl').value.trim(),
    autoTime:   document.getElementById('sAutoTime').value,
  };
  saveState();
  toast('üíæ Param√®tres sauvegard√©s', 'success');
  toggleSettings();
}

function clearDay() {
  if (!confirm('R√©initialiser toutes les missions et l\'historique du jour ?')) return;
  TECHS.forEach(t => state.missions[t] = []);
  state.history = [];
  saveState();
  renderAll();
  toast('üóëÔ∏è Journ√©e r√©initialis√©e', 'info');
  toggleSettings();
}

// ‚îÄ‚îÄ‚îÄ EMAIL REPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendReport(auto = false) {
  const s = state.settings;
  if (!s.email) { toast('‚ö†Ô∏è Email destinataire non configur√©', 'error'); return; }
  if (!s.serviceId || !s.templateId || !s.publicKey) {
    toast('‚ö†Ô∏è EmailJS non configur√© (voir Param√®tres)', 'error');
    return;
  }

  const now = new Date().toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // Build report text
  let lines = [`üìä RAPPORT JOURNALIER ‚Äî ${now}\n`];
  lines.push('‚ïê‚ïê‚ïê MISSIONS EN COURS ‚ïê‚ïê‚ïê');
  TECHS.forEach(tech => {
    const missions = state.missions[tech] || [];
    if (missions.length) {
      missions.forEach(m => {
        lines.push(`\n‚ñ∂ ${tech}: ${m.title}`);
        lines.push(`  Site: ${m.site || 'N/A'} | Priorit√©: ${m.priority}`);
        lines.push(`  Statut: ${STATUS_LABELS[m.status]} | Avancement: ${m.pct}%`);
        if (m.comment) lines.push(`  Note: ${m.comment}`);
      });
    } else {
      lines.push(`\n‚ñ∑ ${tech}: Aucune mission`);
    }
  });

  lines.push('\n‚ïê‚ïê‚ïê MISSIONS TERMIN√âES ‚ïê‚ïê‚ïê');
  if (state.history.length) {
    state.history.forEach(h => {
      lines.push(`\n‚úÖ ${h.tech}: ${h.title}`);
      lines.push(`  Site: ${h.site || 'N/A'} | ${STATUS_LABELS[h.status]} | ${h.pct}%`);
      if (h.completedAt) lines.push(`  Termin√© √†: ${h.completedAt}`);
    });
  } else {
    lines.push('Aucune mission termin√©e');
  }

  const reportText = lines.join('\n');

  emailjs.init(s.publicKey);
  try {
    await emailjs.send(s.serviceId, s.templateId, {
      to_email:   s.email,
      subject:    `TechTrack ‚Äî Rapport du ${now}`,
      report:     reportText,
      date:       now,
      sent_by:    auto ? 'Envoi automatique 18h00' : 'Envoi manuel',
    });
    toast(`üìß Rapport envoy√© √† ${s.email}`, 'success');
  } catch(e) {
    console.error(e);
    toast('‚ùå Erreur envoi email ‚Äî v√©rifiez EmailJS', 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ GOOGLE SHEETS SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncToSheets(tech, mission) {
  const url = state.settings.sheetUrl;
  if (!url || !mission) return;
  try {
    const payload = {
      missionId:  mission.id || '',
      date:       mission.missionDate ? new Date(mission.missionDate).toLocaleDateString('fr-FR') : new Date().toLocaleDateString('fr-FR'),
      tech:       tech,
      title:      mission.title    || '',
      site:       mission.site     || '',
      priority:   mission.priority || '',
      status:     mission.status   || '',
      pct:        mission.pct      || 0,
      comment:    mission.comment  || '',
      timestamp:  new Date().toISOString()
    };
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    console.log('Sheets sync OK', payload);
  } catch(e) { console.warn('Sheets sync failed', e); }
}

// ‚îÄ‚îÄ‚îÄ LOAD FROM SHEETS (Mobile ‚Üí Desktop) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFromSheets() {
  const url = state.settings.sheetUrl;
  if (!url) { toast('‚ö†Ô∏è URL Apps Script non configur√©e dans Param√®tres', 'error'); return; }

  const btn = document.getElementById('btnSyncSheets');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Sync...'; }

  try {
    const data = await fetchSheetsJsonp(url);
    if (data && data.data) {
      const result = mergeSheetMissions(data.data);
      saveState();
      renderAll();
      if (result.total > 0) {
        const parts = [];
        if (result.added    > 0) parts.push(result.added    + ' nouvelle(s)');
        if (result.archived > 0) parts.push(result.archived + ' cl√¥tur√©e(s) ‚Üí historique');
        toast('‚úÖ ' + parts.join(' ¬∑ ') + ' mission(s) synchronis√©e(s)', 'success');
      } else {
        toast('‚úÖ Synchronis√© ‚Äî tout est √† jour', 'info');
      }
    } else {
      toast('‚ö†Ô∏è Sheet vide ou structure invalide', 'error');
    }
  } catch(e) {
    toast('‚ùå Impossible de lire le Sheet ‚Äî v√©rifiez l\'URL Apps Script', 'error');
    console.warn('loadFromSheets error', e);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'üì± Sync Mobile'; }
  }
}

function fetchSheetsJsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = 'ttDesktopCb_' + Date.now();
    const script = document.createElement('script');
    const timer = setTimeout(() => {
      delete window[cbName];
      if (script.parentNode) script.remove();
      reject(new Error('Timeout'));
    }, 8000);
    window[cbName] = (data) => {
      clearTimeout(timer);
      delete window[cbName];
      if (script.parentNode) script.remove();
      resolve(data);
    };
    script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
    script.onerror = () => {
      clearTimeout(timer);
      delete window[cbName];
      if (script.parentNode) script.remove();
      reject(new Error('Script error'));
    };
    document.body.appendChild(script);
  });
}

function mergeSheetMissions(rows) {
  if (!rows || rows.length < 2) return 0;

  // Row 0 = headers
  const headers = rows[0].map(h => String(h || '').trim().toLowerCase());

  // ‚îÄ‚îÄ D√©tection colonnes (FIX: √©viter que 'missionid' matche 'mission' pour title) ‚îÄ‚îÄ
  const idIdx      = headers.findIndex(h => h === 'missionid' || h === 'id');
  const techIdx    = headers.findIndex(h => h === 'tech' || h.includes('tech'));
  const titleIdx   = headers.findIndex(h =>
    (h === 'title' || h === 'titre' || h === 'intitul√©') ||
    (h.includes('title')   && !h.includes('id')) ||
    (h.includes('mission') && !h.includes('id'))
  );
  const siteIdx    = headers.findIndex(h => h === 'site' || h === 'lieu' || (h.includes('site') && !h.includes('web')));
  const statusIdx  = headers.findIndex(h => h === 'status' || h === 'statut' || h.includes('status') || h.includes('statut'));
  // FIX pct : chercher 'pct' en priorit√© absolue, puis variantes
  const pctIdx     = (() => {
    let i = headers.findIndex(h => h === 'pct');
    if (i >= 0) return i;
    i = headers.findIndex(h => h === 'avancement' || h === 'progression' || h === 'percent' || h === '%');
    if (i >= 0) return i;
    return headers.findIndex(h => h.includes('pct') || h.includes('avancement'));
  })();
  const dateIdx    = headers.findIndex(h => h === 'date' || h === 'missiondate' || (h.includes('date') && !h.includes('time')));
  const prioIdx    = headers.findIndex(h => h === 'priority' || h === 'priorit√©' || h.includes('prio'));
  const commentIdx = headers.findIndex(h => h === 'comment' || h === 'commentaire' || h.includes('comment'));

  if (idIdx < 0 || techIdx < 0) {
    console.warn('mergeSheetMissions: colonnes id/tech introuvables', headers);
    return 0;
  }

  let added = 0;
  let archived = 0;
  for (let i = 1; i < rows.length; i++) {
    const row  = rows[i];
    const mId  = String(row[idIdx]  || '').trim();
    const tech = String(row[techIdx] || '').trim();

    if (!mId || !TECHS.includes(tech)) continue;

    const rawTitle = titleIdx >= 0 ? String(row[titleIdx] || '').trim() : '';
    if (!rawTitle || rawTitle === mId) continue;

    const status = statusIdx >= 0
      ? String(row[statusIdx] || 'waiting').trim()
      : 'waiting';

    const missionObj = {
      id:          mId,
      tech:        tech,
      title:       rawTitle,
      site:        siteIdx    >= 0 ? String(row[siteIdx]    || '').trim() : '',
      missionDate: dateIdx    >= 0 ? String(row[dateIdx]    || '').trim() : '',
      start:       '',
      end:         '',
      priority:    prioIdx    >= 0 ? String(row[prioIdx]    || 'Normale').trim() : 'Normale',
      comment:     commentIdx >= 0 ? String(row[commentIdx] || '').trim() : '',
      status:      ['waiting','progress','done','blocked'].includes(status) ? status : 'waiting',
      // FIX: utiliser Number() plus robuste que parseInt, g√©rer string "50", "50%", nombre 50
      pct:         pctIdx >= 0 ? (Math.min(100, Math.max(0, Number(String(row[pctIdx]).replace('%','').trim()) || 0))) : 0,
      source:      'mobile'
    };

    const inHistory  = state.history.some(h => h.id === mId);
    const inMissions = (state.missions[tech] || []).findIndex(m => m.id === mId);

    // ‚îÄ‚îÄ Cas 1 : mission TERMIN√âE (done) ‚îÄ‚îÄ
    if (status === 'done') {
      // D√©j√† dans l'historique ‚Üí rien √† faire
      if (inHistory) continue;
      // √âtait dans les missions actives ‚Üí la retirer et archiver
      if (inMissions >= 0) {
        state.missions[tech].splice(inMissions, 1);
      }
      // Ajouter √† l'historique du bureau
      state.history.push({
        ...missionObj,
        completedAt: new Date().toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' })
      });
      archived++;
      continue;
    }

    // ‚îÄ‚îÄ Cas 2 : mission ACTIVE (waiting / progress / blocked) ‚îÄ‚îÄ
    if (inHistory) continue; // d√©j√† archiv√©e c√¥t√© bureau ‚Üí on ne la ressuscite pas

    if (inMissions >= 0) {
      // FIX: toujours √©craser status ET pct avec les valeurs du Sheet (source de v√©rit√©)
      const sheetPct = missionObj.pct;
      const localMission = state.missions[tech][inMissions];
      // On garde les m√©tadonn√©es locales (title, site...) mais on prend status et pct du Sheet
      state.missions[tech][inMissions] = {
        ...localMission,
        status: missionObj.status,
        pct:    sheetPct,  // FIX: ne plus utiliser || pour √©viter d'√©craser 0 volontaire
      };
    } else {
      // Nouvelle mission venue du mobile ‚Üí l'ajouter
      if (!state.missions[tech]) state.missions[tech] = [];
      state.missions[tech].push(missionObj);
      added++;
    }
  }

  // Message de retour enrichi
  const total = added + archived;
  return { added, archived, total };
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  renderStats();
  renderTechGrid();
  renderHistory();
}

// Close modal on overlay click
document.getElementById('missionModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ‚îÄ‚îÄ‚îÄ START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();

/* ‚ïê‚ïê DASHBOARD JS ‚ïê‚ïê */
let dData = [];
let dFiltered = [];
let dCharts = {};

function showDashboardPage() {
  document.getElementById('page-tracker').classList.remove('active');
  document.getElementById('page-dashboard').classList.add('active');
  document.title = 'TechTrack ‚Äî Dashboard';
  // Set default dates
  const now = new Date();
  const elTo   = document.getElementById('d_to');
  const elFrom = document.getElementById('d_from');
  if (elTo)   elTo.value   = now.toISOString().split('T')[0];
  if (elFrom) elFrom.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  setTimeout(loadData, 100);
}

function loadData() {
  dHideAll();
  dShow('d_empty');
  const em = document.getElementById('d_empty');

  // ‚îÄ‚îÄ Lire localStorage ‚îÄ‚îÄ
  const localRows = [];
  try {
    const raw = localStorage.getItem('techtrack_state');
    if (raw) {
      const stored = JSON.parse(raw);
      Object.entries(stored.missions || {}).forEach(([tech, list]) => {
        (list || []).forEach(m => localRows.push({
          id: m.id||'', date: new Date().toLocaleDateString('fr-FR'),
          missionDate: m.missionDate||'', tech,
          title: m.title||'', site: m.site||'',
          priority: m.priority||'', status: m.status||'waiting',
          pct: m.pct||0, comment: m.comment||''
        }));
      });
      (stored.history||[]).forEach(h => localRows.push({
        id: h.id||'',
        date: h.completedAt ? h.completedAt.split(' ')[0] : new Date().toLocaleDateString('fr-FR'),
        missionDate: h.missionDate||'', tech: h.tech||'',
        title: h.title||'', site: h.site||'',
        priority: h.priority||'', status: h.status||'done',
        pct: h.pct||0, comment: h.comment||''
      }));
    }
  } catch(ex) {}

  // ‚îÄ‚îÄ R√©cup√©rer l'URL Sheet ‚îÄ‚îÄ
  const sheetUrl = (typeof state !== 'undefined' && state.settings && state.settings.sheetUrl)
    ? state.settings.sheetUrl.trim() : '';

  // Afficher √©tat en cours + info debug
  em.innerHTML =
    '<div style="font-size:1.5rem;margin-bottom:.5rem">‚è≥</div>' +
    '<div style="font-family:Syne,sans-serif;font-size:.9rem;font-weight:700;color:#fff;margin-bottom:.5rem">Connexion au Sheet...</div>' +
    '<div style="color:rgba(255,255,255,.75);font-size:.78rem;max-width:380px;margin:0 auto">' +
    (sheetUrl ? 'üîó ' + sheetUrl.substring(0,60) + '...' : '‚ö†Ô∏è Aucune URL Sheet configur√©e dans Param√®tres') +
    '</div>';

  if (!sheetUrl) {
    // Pas d'URL ‚Äî utiliser seulement le localStorage
    setTimeout(() => {
      if (!localRows.length) {
        em.innerHTML =
          '<div style="font-size:2rem;margin-bottom:.5rem">üì≠</div>' +
          '<div style="font-family:Syne,sans-serif;font-size:.95rem;font-weight:700;color:#fff;margin-bottom:.5rem">Aucune donn√©e</div>' +
          '<div style="color:rgba(255,255,255,.8);font-size:.82rem;margin-bottom:1rem">Configurez l\'Apps Script URL dans Param&egrave;tres TechTrack</div>' +
          '<button onclick="dData=dDemo();dRenderAll()" style="background:#3dbfd0;color:#fff;border:none;border-radius:8px;padding:.5rem 1.2rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer">üìä Mode d√©mo</button>';
      } else {
        dData = localRows;
        dShowToast('‚ÑπÔ∏è ' + localRows.length + ' missions locales (configurez le Sheet pour l\'historique)');
        dRenderAll();
      }
    }, 300);
    return;
  }

  // ‚îÄ‚îÄ JSONP vers le Sheet ‚îÄ‚îÄ
  const cbName = 'dCb_' + Date.now();
  let done = false;

  const timer = setTimeout(() => {
    if (done) return;
    done = true;
    cleanup();
    em.innerHTML =
      '<div style="font-size:2rem;margin-bottom:.5rem">‚è±Ô∏è</div>' +
      '<div style="font-family:Syne,sans-serif;font-size:.9rem;font-weight:700;color:#fff;margin-bottom:.75rem">Le Sheet ne r√©pond pas</div>' +
      '<div style="background:rgba(0,0,0,.25);border-radius:10px;padding:.75rem 1rem;font-size:.78rem;color:rgba(255,255,255,.85);text-align:left;max-width:420px;margin:0 auto .75rem;line-height:1.7">' +
      '1. Ouvrez <a href="' + sheetUrl + '?callback=test" target="_blank" style="color:#7ec8c8">ce lien</a> dans un onglet<br>' +
      '2. Si vous voyez du JSON ‚Üí collez-le ci-dessous<br>' +
      '3. Sinon ‚Üí v√©rifiez le d√©ploiement Apps Script' +
      '</div>' +
      '<textarea id="d_manualJson" placeholder="Collez ici le contenu de l&apos;onglet ouvert..." style="width:90%;max-width:420px;height:80px;border-radius:8px;border:none;padding:.5rem;font-size:.75rem;font-family:monospace;resize:vertical"></textarea><br>' +
      '<div style="display:flex;gap:.5rem;justify-content:center;margin-top:.5rem">' +
      '<button onclick="dImportManual()" style="background:#2ecc9a;color:#fff;border:none;border-radius:8px;padding:.45rem 1rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer">‚úÖ Importer</button>' +
      (localRows.length ? '<button onclick="dData=localRows_fallback;dRenderAll()" style="background:#e8a838;color:#fff;border:none;border-radius:8px;padding:.45rem 1rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer">üìã ' + localRows.length + ' locale(s)</button>' : '') +
      '<button onclick="dData=dDemo();dRenderAll()" style="background:#9b7fe8;color:#fff;border:none;border-radius:8px;padding:.45rem 1rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer">üìä D√©mo</button>' +
      '</div>';
    window.localRows_fallback = localRows;
  }, 8000);

  function cleanup() {
    clearTimeout(timer);
    delete window[cbName];
    const sc = document.getElementById('_djsonp');
    if (sc) sc.remove();
  }

  window[cbName] = function(json) {
    if (done) return;
    done = true;
    cleanup();
    try {
      const rows = json.data || json;
      if (!Array.isArray(rows) || rows.length < 2) throw new Error('Sheet vide ou sans ent√™tes');
      const hdrs = rows[0].map(h => String(h).toLowerCase().trim());
      const sheetRows = rows.slice(1).map(row => {
        const o = {}; hdrs.forEach((h,i) => o[h] = row[i]||'');
        const st = String(o['statut']||o['status']||'').toLowerCase();
        return {
          id:          o['missionid']||o['id']||'',
          date:        o['date sync']||o['date']||o['date mission']||'',
          missionDate: o['date']||'',
          tech:        o['tech']||o['technicien']||'',
          title:       o['mission']||o['title']||o['titre']||'',
          site:        o['site']||'',
          priority:    o['priorit√©']||o['priority']||'',
          status:      st.includes('cours')  ? 'progress' :
                       st.includes('termin') ? 'done'     :
                       st.includes('bloqu')  ? 'blocked'  : 'waiting',
          pct:  parseInt(String(o['avancement']||'0').replace('%',''))||0,
          comment: o['commentaire']||o['comment']||''
        };
      }).filter(r => r.tech||r.title);
      const knownIds = new Set(sheetRows.map(r=>r.id).filter(Boolean));
      const extras = localRows.filter(r => !r.id || !knownIds.has(r.id));
      dData = [...sheetRows, ...extras];
      dShowToast('‚úÖ ' + dData.length + ' missions charg√©es');
      dRenderAll();
    } catch(ex) {
      window.localRows_fallback = localRows;
      em.innerHTML =
        '<div style="font-size:2rem;margin-bottom:.5rem">‚ö†Ô∏è</div>' +
        '<div style="font-family:Syne,sans-serif;font-size:.9rem;font-weight:700;color:#fff;margin-bottom:.5rem">Erreur : ' + ex.message + '</div>' +
        (localRows.length ? '<button onclick="dData=localRows_fallback;dRenderAll()" style="background:#e8a838;color:#fff;border:none;border-radius:8px;padding:.45rem 1rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer;margin:.3rem">üìã ' + localRows.length + ' locale(s)</button>' : '') +
        '<button onclick="dData=dDemo();dRenderAll()" style="background:#9b7fe8;color:#fff;border:none;border-radius:8px;padding:.45rem 1rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer;margin:.3rem">üìä D√©mo</button>';
    }
  };

  const sc = document.createElement('script');
  sc.id = '_djsonp';
  sc.src = sheetUrl + '?callback=' + cbName;
  sc.onerror = () => {
    if (done) return; done = true; cleanup();
    em.innerHTML =
      '<div style="font-size:2rem;margin-bottom:.5rem">‚ùå</div>' +
      '<div style="font-family:Syne,sans-serif;font-size:.9rem;font-weight:700;color:#fff;margin-bottom:.75rem">URL inaccessible</div>' +
      '<div style="background:rgba(0,0,0,.25);border-radius:10px;padding:.75rem 1rem;font-size:.78rem;color:rgba(255,255,255,.85);text-align:left;max-width:400px;margin:0 auto .75rem;line-height:1.7">' +
      'Ouvrez <a href="' + sheetUrl + '" target="_blank" style="color:#7ec8c8">l\'URL Apps Script</a> dans un onglet.<br>' +
      'Si cela demande une connexion Google ‚Üí le d√©ploiement est priv√©.<br>' +
      '<strong>Apps Script ‚Üí D√©ployer ‚Üí Modifier ‚Üí Qui a acc√®s = Tout le monde</strong>' +
      '</div>' +
      '<textarea id="d_manualJson" placeholder="Collez ici le JSON de l&apos;onglet..." style="width:90%;max-width:420px;height:80px;border-radius:8px;border:none;padding:.5rem;font-size:.75rem;font-family:monospace;resize:vertical"></textarea><br>' +
      '<div style="display:flex;gap:.5rem;justify-content:center;margin-top:.5rem">' +
      '<button onclick="dImportManual()" style="background:#2ecc9a;color:#fff;border:none;border-radius:8px;padding:.45rem 1rem;font-family:DM Sans,sans-serif;font-weight:600;cursor:pointer">‚úÖ Importer</button>' +
      '</div>';
    window.localRows_fallback = localRows;
  };
  document.head.appendChild(sc);
}

function dImportManual() {
  const ta = document.getElementById('d_manualJson');
  if (!ta) return;
  let raw = ta.value.trim().replace(/^[a-zA-Z_$][\w$]*\s*\(/, '').replace(/\)\s*;?$/, '');
  try {
    const json = JSON.parse(raw);
    const rows = json.data || json;
    if (!Array.isArray(rows) || rows.length < 2) throw new Error('Format non reconnu');
    const hdrs = rows[0].map(h => String(h).toLowerCase().trim());
    dData = rows.slice(1).map(row => {
      const o = {}; hdrs.forEach((h,i) => o[h]=row[i]||'');
      const st = String(o['statut']||'').toLowerCase();
      return {
        id: o['missionid']||'', date: o['date sync']||o['date']||'',
        missionDate: o['date mission']||'', tech: o['tech']||'',
        title: o['mission']||'', site: o['site']||'',
        priority: o['priorit√©']||'',
        status: st.includes('cours')?'progress':st.includes('termin')?'done':st.includes('bloqu')?'blocked':'waiting',
        pct: parseInt(String(o['avancement']||'0').replace('%',''))||0,
        comment: o['commentaire']||''
      };
    }).filter(r => r.tech||r.title);
    if (!dData.length) throw new Error('Aucune ligne valide');
    dShowToast('‚úÖ ' + dData.length + ' missions import√©es');
    dRenderAll();
  } catch(ex) {
    dShowToast('‚ùå ' + ex.message);
  }
}

function dRenderAll() {
  dApplyFilters();
  dShow('d_filters');
  dShow('d_charts');
  dShow('d_table');
  dShow('d_list');
  dHide('d_empty');
}

function dApplyFilters() {
  const period = (document.getElementById('d_period') || {value:'month'}).value;
  const tech   = (document.getElementById('d_tech')   || {value:'all'}).value;
  const status = (document.getElementById('d_status') || {value:'all'}).value;
  const search = ((document.getElementById('d_search') || {value:''}).value || '').toLowerCase();
  const from   = document.getElementById('d_from')?.value;
  const to     = document.getElementById('d_to')?.value;
  const now    = new Date();
  let dFrom, dTo;

  if (period === 'week')  { dFrom = new Date(now); dFrom.setDate(now.getDate()-now.getDay()); dTo = new Date(now); }
  else if (period === 'month') { dFrom = new Date(now.getFullYear(),now.getMonth(),1); dTo = new Date(now); }
  else if (period === 'year')  { dFrom = new Date(now.getFullYear(),0,1); dTo = new Date(now); }
  else { dFrom = from ? new Date(from) : null; dTo = to ? new Date(to) : null; }

  dFiltered = dData.filter(r => {
    if (dFrom || dTo) {
      const d = dParseDate(r.date);
      if (d) {
        if (dFrom && d < dFrom) return false;
        if (dTo   && d > new Date(dTo.getTime()+86400000)) return false;
      }
    }
    if (tech !== 'all' && r.tech !== tech) return false;
    if (status !== 'all' && r.status !== status) return false;
    if (search && !r.title.toLowerCase().includes(search) && !r.site.toLowerCase().includes(search) && !r.tech.toLowerCase().includes(search)) return false;
    return true;
  });

  dRenderKPI();
  dRenderCharts();
  dRenderTable();
  dRenderList();
}

function dashApplyFilters() { dApplyFilters(); }
function dashPeriodChange() {
  const v = document.getElementById('d_period').value;
  const c = document.getElementById('d_customdates');
  if (c) c.style.display = v === 'custom' ? 'flex' : 'none';
  dApplyFilters();
}
function dashReset() {
  ['d_period','d_tech','d_status'].forEach(id => { const el=document.getElementById(id); if(el) el.value = el.id==='d_period'?'month':'all'; });
  const s = document.getElementById('d_search'); if(s) s.value='';
  const c = document.getElementById('d_customdates'); if(c) c.style.display='none';
  dApplyFilters();
}

function dRenderKPI() {
  const total   = dFiltered.length;
  const done    = dFiltered.filter(r=>r.status==='done').length;
  const prog    = dFiltered.filter(r=>r.status==='progress').length;
  const blocked = dFiltered.filter(r=>r.status==='blocked').length;
  const rate    = total ? Math.round(done/total*100) : 0;
  const el = document.getElementById('d_kpi');
  if (!el) return;
  el.style.display = 'grid';
  el.innerHTML = [
    {icon:'üìã',label:'Total missions',value:total,color:'#9b7fe8',sub:'sur la p√©riode'},
    {icon:'‚úÖ',label:'Termin√©es',     value:done,  color:'#2ecc9a',sub:'taux '+rate+'%'},
    {icon:'üîß',label:'En cours',      value:prog,  color:'#3dbfd0',sub:'&nbsp;'},
    {icon:'‚ö†Ô∏è',label:'Bloqu√©es',      value:blocked,color:'#e05c4b',sub:'&nbsp;'},
  ].map(c=>`
    <div style="background:#eef2f5;border-radius:16px;padding:1.6rem 1.8rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;box-shadow:0 4px 16px rgba(0,0,0,.09);border-top:4px solid ${c.color};min-height:110px">
      <div>
        <div style="font-size:1.6rem;margin-bottom:.4rem">${c.icon}</div>
        <div style="font-size:.75rem;color:#5a7080;font-weight:700;text-transform:uppercase;letter-spacing:.05em;margin-bottom:.3rem">${c.label}</div>
        <div style="font-size:.85rem;font-weight:600;color:${c.color}">${c.sub}</div>
      </div>
      <div style="font-family:Syne,sans-serif;font-size:3.4rem;font-weight:800;color:${c.color};line-height:1">${c.value}</div>
    </div>`).join('');
}

function dRenderCharts() {
  const el = document.getElementById('d_charts');
  if (!el) return;
  el.style.display = 'grid';

  const sc = {waiting:0,progress:0,done:0,blocked:0};
  const tc = {Tech1:0,Tech2:0,Tech3:0,Tech4:0};
  const wk = {};
  dFiltered.forEach(r => {
    if (sc[r.status]!==undefined) sc[r.status]++;
    if (tc[r.tech]!==undefined) tc[r.tech]++;
    const d = dParseDate(r.date);
    if (d) {
      const k = dWeekKey(d);
      if (!wk[k]) wk[k]={done:0,progress:0,waiting:0,blocked:0};
      if (wk[k][r.status]!==undefined) wk[k][r.status]++;
    }
  });

  if (dCharts.s) { dCharts.s.destroy(); delete dCharts.s; }
  const cs = document.getElementById('d_chartStatus');
  if (cs) dCharts.s = new Chart(cs, {type:'doughnut',data:{labels:['En attente','En cours','Termin√©','Bloqu√©'],datasets:[{data:Object.values(sc),backgroundColor:['#e8a838','#3dbfd0','#2ecc9a','#e05c4b'],borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:16,font:{family:'DM Sans',size:12}}}}}});

  if (dCharts.t) { dCharts.t.destroy(); delete dCharts.t; }
  const ct = document.getElementById('d_chartTech');
  if (ct) dCharts.t = new Chart(ct, {type:'bar',data:{labels:Object.keys(tc),datasets:[{label:'Missions',data:Object.values(tc),backgroundColor:['#e05c4b','#3dbfd0','#e8a838','#9b7fe8'],borderRadius:8,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'},ticks:{font:{family:'DM Sans'}}},x:{grid:{display:false},ticks:{font:{family:'DM Sans',weight:'600'}}}}}});

  if (dCharts.w) { dCharts.w.destroy(); delete dCharts.w; }
  const cw = document.getElementById('d_chartWeekly');
  const sw = Object.keys(wk).sort();
  if (cw) dCharts.w = new Chart(cw, {type:'bar',data:{labels:sw,datasets:[{label:'Termin√©es',data:sw.map(w=>wk[w].done),backgroundColor:'#2ecc9a',borderRadius:4,borderSkipped:false},{label:'En cours',data:sw.map(w=>wk[w].progress),backgroundColor:'#3dbfd0',borderRadius:4,borderSkipped:false},{label:'En attente',data:sw.map(w=>wk[w].waiting),backgroundColor:'#e8a838',borderRadius:4,borderSkipped:false},{label:'Bloqu√©es',data:sw.map(w=>wk[w].blocked),backgroundColor:'#e05c4b',borderRadius:4,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:16,font:{family:'DM Sans',size:12}}}},scales:{x:{stacked:true,grid:{display:false},ticks:{font:{family:'DM Sans'}}},y:{stacked:true,beginAtZero:true,grid:{color:'#f1f5f9'},ticks:{font:{family:'DM Sans'}}}}}});
}

function dRenderTable() {
  const el = document.getElementById('d_table');
  const tbody = document.getElementById('d_techBody');
  if (!el || !tbody) return;
  el.style.display = 'block';
  const max = Math.max(...['Tech1','Tech2','Tech3','Tech4'].map(t=>dFiltered.filter(r=>r.tech===t).length)) || 1;
  const TC = {Tech1:'#e05c4b',Tech2:'#3dbfd0',Tech3:'#e8a838',Tech4:'#9b7fe8'};
  tbody.innerHTML = ['Tech1','Tech2','Tech3','Tech4'].map(tech => {
    const rows = dFiltered.filter(r=>r.tech===tech);
    const tot=rows.length, d=rows.filter(r=>r.status==='done').length;
    const p=rows.filter(r=>r.status==='progress').length, w=rows.filter(r=>r.status==='waiting').length, b=rows.filter(r=>r.status==='blocked').length;
    const rate=tot?Math.round(d/tot*100):0, bw=Math.round(tot/max*100), rc=rate>=70?'#2ecc9a':rate>=40?'#e8a838':'#e05c4b';
    return `<tr style="border-bottom:1px solid #f1f5f9">
      <td style="padding:.75rem 1rem"><span style="width:10px;height:10px;border-radius:50%;background:${TC[tech]};display:inline-block;margin-right:.5rem"></span><strong>${tech}</strong></td>
      <td style="padding:.75rem 1rem"><div style="display:flex;align-items:center;gap:.6rem"><span style="font-family:Syne,sans-serif;font-weight:700;color:${TC[tech]};min-width:24px">${tot}</span><div style="flex:1;height:6px;background:#f1f5f9;border-radius:999px;overflow:hidden"><div style="width:${bw}%;height:100%;background:${TC[tech]};border-radius:999px"></div></div></div></td>
      <td style="padding:.75rem 1rem;font-family:Syne,sans-serif;font-weight:700;color:#2ecc9a">${d}</td>
      <td style="padding:.75rem 1rem;font-family:Syne,sans-serif;font-weight:700;color:#3dbfd0">${p}</td>
      <td style="padding:.75rem 1rem;font-family:Syne,sans-serif;font-weight:700;color:#e8a838">${w}</td>
      <td style="padding:.75rem 1rem;font-family:Syne,sans-serif;font-weight:700;color:#e05c4b">${b}</td>
      <td style="padding:.75rem 1rem"><div style="display:flex;align-items:center;gap:.5rem"><span style="font-family:Syne,sans-serif;font-weight:700;color:${rc}">${rate}%</span><div style="width:80px;height:6px;background:#f1f5f9;border-radius:999px;overflow:hidden"><div style="width:${rate}%;height:100%;background:${rc};border-radius:999px"></div></div></div></td>
    </tr>`;
  }).join('');
}

function dRenderList() {
  const el = document.getElementById('d_list');
  const tbody = document.getElementById('d_listBody');
  const cnt = document.getElementById('d_count');
  if (!el || !tbody) return;
  el.style.display = 'block';
  if (cnt) cnt.textContent = dFiltered.length + ' r√©sultat' + (dFiltered.length>1?'s':'');
  const SL = {waiting:'‚è≥ Attente',progress:'üîß En cours',done:'‚úÖ Termin√©',blocked:'‚ö†Ô∏è Bloqu√©'};
  const SC = {waiting:'rgba(232,168,56,.15)',progress:'rgba(61,191,208,.15)',done:'rgba(46,204,154,.15)',blocked:'rgba(224,92,75,.15)'};
  const ST = {waiting:'#b45309',progress:'#0e7490',done:'#065f46',blocked:'#991b1b'};
  const TC = {Tech1:'#e05c4b',Tech2:'#3dbfd0',Tech3:'#e8a838',Tech4:'#9b7fe8'};
  tbody.innerHTML = dFiltered.slice(0,100).map(r=>`
    <tr style="border-bottom:1px solid #f1f5f9">
      <td style="padding:.75rem 1rem"><span style="font-family:monospace;font-size:.78rem;background:#f1f5f9;padding:.15rem .4rem;border-radius:5px;color:#475569">${r.id?'#'+r.id.slice(-6).toUpperCase():'‚Äî'}</span></td>
      <td style="padding:.75rem 1rem;color:#64748b;white-space:nowrap">${r.missionDate||r.date||'‚Äî'}</td>
      <td style="padding:.75rem 1rem;font-weight:700;color:${TC[r.tech]||'#64748b'}">${r.tech||'‚Äî'}</td>
      <td style="padding:.75rem 1rem;font-weight:500;max-width:200px">${r.title||'‚Äî'}</td>
      <td style="padding:.75rem 1rem;color:#64748b">${r.site||'‚Äî'}</td>
      <td style="padding:.75rem 1rem"><span style="font-size:.7rem;font-weight:700;padding:.2rem .6rem;border-radius:999px;background:${SC[r.status]||''};color:${ST[r.status]||'#64748b'}">${SL[r.status]||r.status}</span></td>
      <td style="padding:.75rem 1rem">
        <div style="display:flex;align-items:center;gap:.4rem">
          <span style="font-weight:700;font-size:.82rem;min-width:32px">${r.pct}%</span>
          <div style="width:60px;height:6px;background:#f1f5f9;border-radius:999px;overflow:hidden"><div style="width:${r.pct}%;height:100%;background:#3dbfd0;border-radius:999px"></div></div>
        </div>
      </td>
    </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#94a3b8">Aucun r√©sultat</td></tr>';
}

function dParseDate(str) {
  if (!str) return null;
  if (str.includes('T')) return new Date(str);
  const p = str.split('/');
  if (p.length===3) return new Date(p[2],p[1]-1,p[0]);
  return new Date(str);
}
function dWeekKey(d) {
  const dd = new Date(d); dd.setHours(0,0,0,0); dd.setDate(dd.getDate()-dd.getDay()+1);
  return String(dd.getDate()).padStart(2,'0')+'/'+String(dd.getMonth()+1).padStart(2,'0');
}
function dShow(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (id === 'd_kpi') el.style.display = 'grid';
  else if (id === 'd_filters') el.style.display = 'flex';
  else if (id === 'd_charts') el.style.display = 'grid';
  else el.style.display = 'block';
}
function dHide(id) { const el=document.getElementById(id); if(el) el.style.display='none'; }
function dHideAll() { ['d_kpi','d_filters','d_charts','d_table','d_list'].forEach(dHide); }
function dShowToast(msg) {
  const t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:1.5rem;right:1.5rem;z-index:9999;background:#fff;border-radius:12px;padding:.75rem 1.2rem;font-size:.85rem;box-shadow:0 8px 24px rgba(0,0,0,.15);border-left:4px solid #3dbfd0;max-width:320px;color:#1a202c';
  t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),4000);
}
function dDemo() {
  const ts=['Tech1','Tech2','Tech3','Tech4'],st=['done','done','progress','waiting','blocked'],tt=['R√©paration climatiseur','Maintenance chaudi√®re','Contr√¥le √©lectrique','Remplacement vanne','Nettoyage filtre'],si=['B√¢timent A','B√¢timent B','Site Nord','Atelier'];
  const rows=[];
  for(let i=0;i<60;i++){const d=new Date();d.setDate(d.getDate()-Math.floor(Math.random()*60));rows.push({id:Math.random().toString(36).substr(2,8).toUpperCase(),date:d.toLocaleDateString('fr-FR'),missionDate:d.toLocaleDateString('fr-FR'),tech:ts[i%4],title:tt[i%5],site:si[i%4],priority:'Normale',status:st[Math.floor(Math.random()*st.length)],pct:Math.floor(Math.random()*100),comment:''});}
  return rows;
}

// ‚ïê‚ïê PDF & MAIL DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getPeriodLabel() {
  const period = (document.getElementById('d_period')||{value:'month'}).value;
  const from   = document.getElementById('d_from')?.value;
  const to     = document.getElementById('d_to')?.value;
  const fmt    = d => d ? new Date(d).toLocaleDateString('fr-FR') : '';
  const now    = new Date();
  if (period === 'week')   return 'Semaine du ' + fmt(new Date(now.setDate(now.getDate()-now.getDay()+1)));
  if (period === 'month')  return new Date().toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  if (period === 'year')   return 'Ann√©e ' + new Date().getFullYear();
  if (from || to)          return 'Du ' + fmt(from) + ' au ' + fmt(to);
  return 'Toutes p√©riodes';
}

function openPdfMailModal() {
  if (!dData.length) { dShowToast('‚ö†Ô∏è Chargez d\'abord les donn√©es'); return; }
  const period = getPeriodLabel();
  document.getElementById('d_pdfPeriodLabel').textContent = 'üìÖ P√©riode : ' + period;
  document.getElementById('d_mailSubject').value = 'Tableau de bord TechTrack ‚Äî ' + period;
  // Pre-fill email from TechTrack settings
  const email = (typeof state !== 'undefined' && state.settings && state.settings.email)
    ? state.settings.email : '';
  document.getElementById('d_mailTo').value = email;
  document.getElementById('d_mailCc').value = '';
  document.getElementById('d_pdfStatus').style.display = 'none';
  const modal = document.getElementById('d_pdfModal');
  modal.style.display = 'flex';
}

async function captureDashboard() {
  // Temporarily hide modal and controls not needed in PDF
  const modal = document.getElementById('d_pdfModal');
  const setup = document.getElementById('d_appsSetup');
  const hdr   = document.querySelector('#page-dashboard [style*="sticky"]');
  modal.style.display = 'none';
  if (setup) setup.style.display = 'none';

  // Add PDF title
  const period = getPeriodLabel();
  const titleDiv = document.createElement('div');
  titleDiv.id = '_pdfTitle';
  titleDiv.style.cssText = 'font-family:Syne,sans-serif;font-size:1.4rem;font-weight:800;color:#1a202c;padding:1rem 2rem .5rem;background:#fff';
  titleDiv.textContent = 'Tableau de bord TechTrack ‚Äî ' + period;
  const dashContent = document.querySelector('#page-dashboard > div:last-child');
  dashContent.insertBefore(titleDiv, dashContent.firstChild);

  try {
    const canvas = await html2canvas(dashContent, {
      scale: 1.5,
      useCORS: true,
      backgroundColor: '#5b9ecf',
      logging: false,
      windowWidth: 1400,
    });
    return canvas;
  } finally {
    titleDiv.remove();
    if (setup) setup.style.display = '';
    modal.style.display = 'flex';
  }
}

async function downloadDashboardPdf() {
  setPdfStatus('‚è≥ G√©n√©ration du PDF...', '#e8a838');
  try {
    const canvas = await captureDashboard();
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
    const pW = pdf.internal.pageSize.getWidth();
    const pH = pdf.internal.pageSize.getHeight();
    const imgH = (canvas.height * pW) / canvas.width;
    let y = 0;
    let remaining = imgH;
    while (remaining > 0) {
      if (y > 0) pdf.addPage();
      const sliceH = Math.min(pH, remaining);
      const sliceCanvas = document.createElement('canvas');
      sliceCanvas.width  = canvas.width;
      sliceCanvas.height = (sliceH / pW) * canvas.width;
      const ctx = sliceCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, (y / pW) * canvas.width, canvas.width, sliceCanvas.height, 0, 0, canvas.width, sliceCanvas.height);
      pdf.addImage(sliceCanvas.toDataURL('image/jpeg', 0.92), 'JPEG', 0, 0, pW, sliceH);
      y += pH;
      remaining -= pH;
    }
    const period = getPeriodLabel().replace(/[^a-zA-Z0-9]/g, '_');
    pdf.save('TechTrack_' + period + '.pdf');
    setPdfStatus('‚úÖ PDF t√©l√©charg√© !', '#2ecc9a');
  } catch(e) {
    setPdfStatus('‚ùå Erreur : ' + e.message, '#e05c4b');
  }
}

async function sendDashboardPdf() {
  const to      = document.getElementById('d_mailTo').value.trim();
  const cc      = document.getElementById('d_mailCc').value.trim();
  const subject = document.getElementById('d_mailSubject').value.trim();
  if (!to) { setPdfStatus('‚ö†Ô∏è Veuillez saisir un destinataire', '#e8a838'); return; }

  const s = (typeof state !== 'undefined') ? state.settings : {};
  if (!s.serviceId || !s.templateId || !s.publicKey) {
    setPdfStatus('‚ö†Ô∏è EmailJS non configur√© dans Param√®tres TechTrack', '#e8a838');
    return;
  }

  setPdfStatus('‚è≥ Capture et envoi en cours...', '#e8a838');

  try {
    const canvas = await captureDashboard();
    const imgData = canvas.toDataURL('image/jpeg', 0.85);

    // Build HTML summary for email body
    const total   = dFiltered.length;
    const done    = dFiltered.filter(r=>r.status==='done').length;
    const prog    = dFiltered.filter(r=>r.status==='progress').length;
    const blocked = dFiltered.filter(r=>r.status==='blocked').length;
    const rate    = total ? Math.round(done/total*100) : 0;
    const period  = getPeriodLabel();

    const techLines = ['Tech1','Tech2','Tech3','Tech4'].map(t => {
      const r = dFiltered.filter(x=>x.tech===t);
      return r.length ? t + ' : ' + r.length + ' mission(s) ‚Äî ' + r.filter(x=>x.status==='done').length + ' termin√©e(s)' : null;
    }).filter(Boolean).join('\n');
    const body = 'Tableau de bord TechTrack ‚Äî ' + period + '\n\n'
      + 'üìä SYNTH√àSE\n'
      + '‚Ä¢ Total missions : ' + total + '\n'
      + '‚Ä¢ Termin√©es : ' + done + ' (' + rate + '%)\n'
      + '‚Ä¢ En cours : ' + prog + '\n'
      + '‚Ä¢ Bloqu√©es : ' + blocked + '\n\n'
      + techLines + '\n\n'
      + 'Le PDF du dashboard est joint √† cet email.';

    emailjs.init(s.publicKey);
    const params = {
      to_email:   to,
      cc_email:   cc || '',
      subject:    subject || 'Tableau de bord TechTrack ‚Äî ' + period,
      message:    body,
      dashboard_image: imgData,
    };
    await emailjs.send(s.serviceId, s.templateId, params);
    setPdfStatus('‚úÖ Email envoy√© √† ' + to + (cc ? ' + ' + cc : ''), '#2ecc9a');
  } catch(e) {
    setPdfStatus('‚ùå Erreur envoi : ' + e.message + ' ‚Äî Utilisez "PDF local" et envoyez manuellement', '#e05c4b');
  }
}

function setPdfStatus(msg, color) {
  const el = document.getElementById('d_pdfStatus');
  if (!el) return;
  el.style.display = 'block';
  el.style.background = color + '22';
  el.style.borderLeft = '3px solid ' + color;
  el.style.color = color === '#2ecc9a' ? '#065f46' : color === '#e8a838' ? '#92400e' : '#991b1b';
  el.textContent = msg;
}

// ‚ïê‚ïê FERMER TECHTRACK ‚ïê‚ïê
function closeTechTrack() {
  window.close();
  // Fallback si window.close() est bloqu√© par le navigateur
  document.body.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(145deg,#1a202c,#2d3748);font-family:Syne,sans-serif;color:#fff;gap:1.5rem"><div style="font-size:2.5rem;font-weight:800">Tech<span style="color:#3dbfd0">Track</span></div><div style="font-size:1.1rem;opacity:.7">Application ferm√©e ‚Äî vous pouvez fermer cet onglet.</div><button onclick="window.close()" style="margin-top:1rem;padding:.7rem 2rem;background:#3dbfd0;color:#fff;border:none;border-radius:10px;font-size:1rem;font-weight:700;cursor:pointer;font-family:DM Sans,sans-serif">‚úï Fermer l\'onglet</button></div>';
}

// Init dates par d√©faut pour le dashboard
(function() {
  const now = new Date();
  const elTo   = document.getElementById('d_to');
  const elFrom = document.getElementById('d_from');
  if (elTo)   elTo.value   = now.toISOString().split('T')[0];
  if (elFrom) elFrom.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const elPer  = document.getElementById('d_period');
  if (elPer) elPer.addEventListener('change', function() {
    const c = document.getElementById('d_customdates');
    if (c) c.style.display = this.value === 'custom' ? 'flex' : 'none';
    dApplyFilters();
  });
})();

// ‚ïê‚ïê PLEIN √âCRAN ‚ïê‚ïê
function enterFullscreen() {
  const el = document.documentElement;
  const req = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
  if (req) req.call(el).then(() => {
    document.getElementById('fsSplash').style.display = 'none';
    updateFsBtn();
  }).catch(() => {
    document.getElementById('fsSplash').style.display = 'none';
  });
}

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    enterFullscreen();
  } else {
    (document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen).call(document);
  }
}

function updateFsBtn() {
  const icon = document.fullscreenElement ? '‚úï‚õ∂' : '‚õ∂';
  document.querySelectorAll('#btnFs').forEach(b => b.textContent = icon);
}

document.addEventListener('fullscreenchange', updateFsBtn);

// Afficher splash au chargement
window.addEventListener('load', () => {
  const splash = document.getElementById('fsSplash');
  splash.style.display = 'flex';
});
</script>
<!-- SPLASH FULLSCREEN -->
<div id="fsSplash" style="display:none;position:fixed;inset:0;z-index:9999;background:linear-gradient(145deg,#1a202c,#2d3748);align-items:center;justify-content:center;flex-direction:column;cursor:pointer" onclick="enterFullscreen()">
  <div style="font-family:'Syne',sans-serif;font-size:2.5rem;font-weight:800;color:#fff;margin-bottom:.5rem">Tech<span style="color:#3dbfd0">Track</span></div>
  <div style="font-size:3.5rem;margin:1.5rem 0;animation:pulse 1.5s infinite">‚õ∂</div>
  <div style="font-family:'DM Sans',sans-serif;font-size:1.1rem;font-weight:600;color:rgba(255,255,255,.9);margin-bottom:.5rem">Cliquez pour ouvrir ...</div>
  <div style="font-family:'DM Sans',sans-serif;font-size:.82rem;color:rgba(255,255,255,.5)">.................n</div>
  <style>@keyframes pulse{0%,100%{transform:scale(1);opacity:.7}50%{transform:scale(1.15);opacity:1}}</style>
</div>
<!-- SPLASH FULLSCREEN -->
<div id="fsSplash" style="display:none;position:fixed;inset:0;z-index:9999;background:linear-gradient(145deg,#1a202c,#2d3748);align-items:center;justify-content:center;flex-direction:column;cursor:pointer" onclick="enterFullscreen()">
  <div style="font-family:'Syne',sans-serif;font-size:2.5rem;font-weight:800;color:#fff;margin-bottom:.5rem">Tech<span style="color:#3dbfd0">Track</span></div>
  <div style="font-size:4rem;margin:1.5rem 0;animation:fsPulse 1.5s infinite">‚õ∂</div>
  <div style="font-family:'DM Sans',sans-serif;font-size:1.1rem;font-weight:600;color:rgba(255,255,255,.9);margin-bottom:.5rem">Cliquez pour ouvrir ...</div>
  <div style="font-family:'DM Sans',sans-serif;font-size:.82rem;color:rgba(255,255,255,.5)">ou <span style="text-decoration:underline;cursor:pointer" onclick="event.stopPropagation();document.getElementById('fsSplash').style.display='none'">continuer sans plein √©cran</span></div>
  <style>@keyframes fsPulse{0%,100%{transform:scale(1);opacity:.7}50%{transform:scale(1.2);opacity:1}}</style>
</div>
</body>
</html>
